<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AI Architectural Synthesis Workbench</title>
    <style>
        /* ----------------------------------------------------------------- */
        /* --- ARCHITECTURAL MINIMALISM THEME: CSS VARIABLES (LIGHT MODE) --- */
        /* ----------------------------------------------------------------- */
        :root {
            /* Palette */
            --bg: #f5f5f5;           /* Light Background */
            --panel: #ffffff;        /* Main Panel Background (White) */
            --card: #ffffff;         /* Card Background */
            --border: #e0e0e0;       /* Thin, light border */
            --text: #1c1c1c;         /* Dark Text */
            --muted: #616161;        /* Muted/Secondary Text */
            --accent: #3A4750;       /* Black/Dark Slate Accent */
            --accent-light: #5d666d;
            --focus-border: #757575; /* Focus/Active Border */

            /* Buttons */
            --primary-btn-bg: var(--accent);
            --primary-btn-text: #ffffff;
            --secondary-btn-bg: #f0f0f0;
            --secondary-btn-border: #cccccc;
            --secondary-btn-text: var(--text);

            /* Status & Semantic Colors */
            --danger: #d32f2f;       /* Red */
            --ok: #388e3c;           /* Green */
            --warn: #ffa000;         /* Amber/Orange */

            /* Fonts & Shadows */
            --font-family: 'Roboto', 'Helvetica Neue', 'Inter', sans-serif;
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.05); /* Subtle shadow for depth */
        }

        /* --------------------------- */
        /* --- BASE STYLES & LAYOUT --- */
        /* --------------------------- */
        body {
            margin: 0;
            font-family: var(--font-family);
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Main Header */
        #main-header {
            padding: 16px 30px;
            border-bottom: 1px solid var(--border);
            position: sticky;
            top: 0;
            background: var(--panel);
            box-shadow: var(--shadow);
            z-index: 100;
        }
        #main-header h1 {
            margin: 0 0 4px;
            font-size: 28px;
            font-weight: 300; /* Thin font weight */
            color: var(--accent);
        }
        #model-note {
            color: var(--muted);
            font-size: 13px;
            margin-bottom: 12px;
            display: block;
        }

        /* Tab System Styling */
        #tab-list {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 10px 0 0 0;
        }
        .tab-button {
            padding: 10px 0;
            margin-right: 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--muted);
            font-size: 16px;
            font-weight: 400;
            border-bottom: 2px solid transparent;
            transition: color 0.2s, border-bottom-color 0.2s, background 0.2s;
        }
        .tab-button:hover {
            color: var(--text);
            border-bottom-color: var(--border);
        }
        .tab-button[aria-selected="true"] {
            color: var(--accent);
            border-bottom-color: var(--accent);
            font-weight: 500;
        }
        .tab-button:focus-visible {
            outline: none;
            box-shadow: inset 0 -2px 0 0 var(--accent);
        }

        /* Main Content Container */
        #main-content {
            padding: 30px;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Tab Panel Styling */
        .tab-panel {
            display: none;
            padding-top: 20px;
        }
        .tab-panel[aria-hidden="false"] {
            display: block;
        }

        /* Global Elements: Card & Input Consistency */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 4px; /* Slightly rounded, geometric */
            padding: 20px;
            box-shadow: var(--shadow);
        }

        label {
            display: block;
            font-size: 14px;
            color: var(--muted);
            margin-bottom: 8px;
            margin-top: 15px; /* Add spacing above labels */
            font-weight: 500;
        }
        label:first-child {
            margin-top: 0;
        }

        input[type="text"], input[type="password"], select, textarea {
            width: 100%;
            background: var(--panel);
            color: var(--text);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 12px 14px;
            font-size: 14px;
            outline: none;
            box-sizing: border-box;
            transition: border-color .15s ease, box-shadow .15s ease;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--focus-border);
            box-shadow: 0 0 0 1px var(--focus-border);
        }
        textarea {
            min-height: 80px;
            resize: vertical;
        }

        /* Global Button Styles */
        .button, #socio-container button {
            appearance: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 18px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
            line-height: 1.2;
            text-align: center;
            height: 40px;
            box-sizing: border-box;
        }
        /* Primary (Dark Accent) */
        .button.primary, #socio-container .primary {
            border: 1px solid var(--primary-btn-bg);
            background: var(--primary-btn-bg);
            color: var(--primary-btn-text);
        }
        .button.primary:hover, #socio-container .primary:hover {
            background: var(--accent-light);
            border-color: var(--accent-light);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        /* Secondary (Light/Outline) */
        .button.secondary, #socio-container button {
            border: 1px solid var(--secondary-btn-border);
            background: var(--secondary-btn-bg);
            color: var(--secondary-btn-text);
        }
        .button.secondary:hover, #socio-container button:not(.primary, .accent, .danger):hover {
            background: #e0e0e0;
            border-color: #bbbbbb;
        }

        /* Utility Styles for Socio-Cultural Tab (Re-mapping Dark Mode classes to Light Mode) */
        #socio-container .accent {
            border: 1px solid var(--focus-border);
            background: var(--secondary-btn-bg);
            color: var(--text);
        }
        #socio-container .accent:hover {
            background: #e0e0e0;
        }
        #socio-container .danger {
            border: 1px solid var(--danger);
            background: #ffebee;
            color: var(--danger);
        }
        #socio-container .danger:hover {
            background: #ffcdd2;
        }

        /* ----------------------------------------------------------------------- */
        /* --- Styles for Socio-Cultural Site Analysis (TWEAK) - PRESERVED IDS --- */
        /* ----------------------------------------------------------------------- */

        #socio-container {
            display: grid;
            gap: 30px;
            grid-template-columns: 1.1fr .9fr;
        }
        @media (max-width: 1100px) {
            #socio-container { grid-template-columns: 1fr; }
        }
        #socio-container .card {
            /* Inherited from global card */
            padding: 25px;
        }
        #socio-container h2 {
            margin: 0 0 15px;
            font-size: 20px;
            font-weight: 500;
            color: var(--accent);
        }
        /* Overriding specific dark-mode inputs from original style sheet */
        #socio-container input[type="text"], #socio-container input[type="password"], #socio-container select, #socio-container textarea {
            background: var(--panel);
        }
        #socio-container .row { display: grid; gap: 15px; grid-template-columns: 1fr 1fr; }
        #socio-container .btns { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }

        /* Status Indicator */
        #socio-container .status { display:flex; align-items:center; gap:8px; font-size:14px; color:var(--muted); height: 40px; margin-top: 6px;}
        #socio-container .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--warn); }
        #socio-container .dot.ok { background: var(--ok); }
        #socio-container .dot.err { background: var(--danger); }

        /* Results Display */
        #socio-container .results, #socio-container .log, #socio-container .ai-response-pre, #socio-container .json-box {
            background: #fcfcfc; /* Very light background for output/log */
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 15px;
            font-size: 13px;
            overflow: auto;
            line-height: 1.6;
            font-family: Consolas, monospace;
            color: var(--text);
            white-space: pre-wrap;
        }
        #socio-container .results { max-height: 550px; }
        #socio-container .log { height: 200px; }

        #socio-container .result-block {
            border:1px solid var(--border); /* Solid border for light theme */
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            background: #ffffff;
            box-shadow: var(--shadow);
        }
        #socio-container .result-block h3 { margin: 0 0 8px; font-size: 16px; color: var(--accent); font-weight: 500;}
        #socio-container .result-block .meta { color: var(--muted); font-size: 12px; margin-bottom: 10px; }
        #socio-container .muted { color: var(--muted); font-size: 12px; }

        /* Log Colors (Adjusted for Light Theme) */
        #socio-container .log .t { color:#4a86e8 } /* Timestamp/General */
        #socio-container .log .e { color:var(--danger) } /* Error */
        #socio-container .log .s { color:var(--ok) } /* Success */
        #socio-container .log .w { color:var(--warn) } /* Warning */

        /* Separator Headings */
        .separator-label {
            display: block;
            margin: 20px 0 10px;
            font-size: 16px;
            font-weight: 500;
            color: var(--accent);
            padding-bottom: 5px;
            border-bottom: 1px dashed var(--border);
        }
        /* Specific Tool Headings */
        #socio-container h3.separator-label { font-size: 18px; margin-top: 25px; }

        /* Persona Cards */
        #socio-container .persona-card {
            border: 1px solid var(--border);
            background: #fcfcfc;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.05);
        }
        #socio-container .persona-card h3 { margin:0 0 8px; font-size:16px; color:var(--accent) }
        #socio-container .persona-grid.multi {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        }
        #socio-container .tag {
            display:inline-block; font-size:11px; padding:3px 10px; border-radius:15px;
            border:1px solid #c0c0c0; background:#f0f0f0; color:var(--text); margin-right:6px;
            font-weight: 500;
        }

        /* Opinion Pros/Cons Lists */
        #socio-container .opinion-list { list-style-type: none; padding-left: 0; margin-top: 8px; }
        #socio-container .pros li, #socio-container .cons li {
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 6px;
            border-left: 4px solid;
            background: #f9f9f9;
        }
        #socio-container .pros li {
            border-left-color: var(--ok);
            color: var(--ok);
        }
        #socio-container .cons li {
            border-left-color: var(--danger);
            color: var(--danger);
        }
        #socio-container .status-message {
            text-align: center;
        }

        /* AIPRAA Specific Styling */
        #socio-imagePreviewContainer img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        /* ----------------------------------------------------------- */
        /* --- Styles for Sketch Enhancer (SKETCH) - PRESERVED IDS --- */
        /* ----------------------------------------------------------- */

        #sketch-container {
            display: grid;
            grid-template-columns: 1fr 350px; /* Slightly wider sidebar */
            gap: 30px;
        }
        @media (max-width: 900px) {
            #sketch-container { grid-template-columns: 1fr; }
        }
        #sketch-container .card {
            padding: 25px;
        }

        /* Input overrides for Sketch tab */
        #sketch-container input[type=text], #sketch-container select, #sketch-container textarea {
            max-width: 100%; /* Ensure full width in grid column */
        }
        #sketch-container select {
            width: 100%;
        }

        /* Canvas Style */
        #sketch-container canvas {
            background: #ffffff;
            border: 1px solid var(--border);
            width: 100%;
            height: 450px;
            display: block;
            border-radius: 4px;
            margin-top: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }

        /* Upload Controls */
        #sketch-container .upload-controls { display: grid; gap: 10px; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; margin-top: 15px; }
        #sketch-container .upload-label {
            height: 38px;
            border: 1px solid var(--border);
            background: var(--secondary-btn-bg);
            color: var(--text);
            font-size: 13px;
            font-weight: 400;
            border-radius: 4px;
        }
        #sketch-container .upload-label:hover { background: #e0e0e0; border-color: #bbbbbb; }
        #sketch-container .upload-label.active {
            background: #e6f3ff; /* Light blue tint for active file upload */
            color: var(--accent);
            border-color: #a8cfff;
        }
        #sketch-container .file-info { font-size: 11px; color: var(--muted); margin-top: 4px; margin-bottom: 8px; }
        #sketch-container .warning { color: var(--danger); font-weight: 400; margin-top: 4px; font-size: 12px; }

        /* Toolbar/Controls */
        #sketch-container .controls { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; align-items: center }
        #sketch-container .button { height: 45px; } /* Taller buttons for prominence */

        /* Results & Log */
        #sketch-container .results, #sketch-container .bug-log {
            background: #fcfcfc;
            border-radius: 4px;
            padding: 15px;
            min-height: 100px;
            overflow: auto;
            font-size: 13px;
            border: 1px solid var(--border);
            color: var(--text);
            font-family: Consolas, monospace;
        }
        #sketch-container .bug-log { min-height: 150px; }
        #sketch-container .log-entry { border-bottom: 1px solid var(--border); padding: 6px 0; font-size: 13px; }
        #sketch-container .log-entry:last-child { border-bottom: none; }
        #sketch-container .small { font-size: 12px; color: var(--muted) }
        #sketch-container .log-entry strong { color: var(--accent); font-weight: 500;}

        /* History */
        #sketch-history {
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        #sketch-history .history-item {
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 8px;
            background: #fcfcfc;
            text-align: center;
        }
        #sketch-history .history-item img {
            width: 100%;
            height: auto;
            border-radius: 2px;
            cursor: zoom-in;
            display: block;
        }
        /* Result Image */
        #sketch-results img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
            border: 1px solid var(--border);
        }

        /* Modal */
        #sketch-container #imageModal {
            display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, .85);
            align-items: center; justify-content: center; z-index: 2000;
        }
        #sketch-container #imageModal img {
            max-width: 90%; max-height: 90%; border-radius: 4px; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        /* Visual Transparency Label */
        .visual-transparency-label {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 8px 15px;
            font-size: 12px;
            color: var(--muted);
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 4px 4px 0 0;
            z-index: 200;
            box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.05);
        }

        /* Spinner Styles (minimal) */
        .spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spinner.-ml-1 { margin-left: -0.25rem; }
        .spinner.mr-2 { margin-right: 0.5rem; }
        .spinner.h-4 { height: 1rem; }
        .spinner.w-4 { width: 1rem; }
        .spinner.text-white { color: #ffffff; } /* For primary buttons */
        /* Opacity/Path are for SVG, keeping original class names */
        .opacity-25 { opacity: 0.25; }
        .opacity-75 { opacity: 0.75; }

    </style>
</head>
<body>

    <header id="main-header">
        <h1>AiRchitecture Workbook</h1>
        <span id="model-note"> Become a better designer using AI</span>
        <nav role="tablist" id="tab-nav">
            <ul id="tab-list">
                <li role="presentation">
                    <button id="tab-btn-sketch" class="tab-button" role="tab" aria-controls="tab-panel-sketch" aria-selected="true" tabindex="0">Sketch Enhancer</button>
                </li>
                <li role="presentation">
                    <button id="tab-btn-socio" class="tab-button" role="tab" aria-controls="tab-panel-socio" aria-selected="false" tabindex="-1">Socio-Cultural Site Analysis</button>
                </li>
            </ul>
        </nav>
    </header>

    <main id="main-content">
        <section id="tab-panel-sketch" class="tab-panel" role="tabpanel" aria-labelledby="tab-btn-sketch" aria-hidden="false">
            <div id="sketch-container">
                <section class="card">
                    <label for="sketch-providerSelect">Provider</label>
                    <select id="sketch-providerSelect">
                        <option value="gemini" selected>Google Gemini</option>
                        <option value="freepik">Freepik</option>
                        <option value="openai">OpenAI</option>
                    </select>

                    <div style="margin-top:15px;">
                        <button id="sketch-modeToggleBtn" class="button secondary" style="width:100%; height: 45px;">
                            Mode: Studio ðŸ§±
                        </button>
                    </div>

                    <label for="sketch-apiKeyInput">API Key</label>
                    <input type="text" id="sketch-apiKeyInput" placeholder="Paste your API key here"/>

                    <label for="sketch-promptInput">Prompt (Style, Materials, Color)</label>
                    <div class="input-group canvas-wrapper">
                        <textarea id="sketch-promptInput" placeholder="e.g., modern minimalist style, polished concrete, high-contrast, dramatic lighting"></textarea>
                    </div>

                    <label>Reference Files</label>
                    <div class="upload-controls" id="sketch-uploadControls">
                        <div class="upload-row">
                            <label id="sketch-briefLabel" class="upload-label">
                                <input id="sketch-briefInput" type="file" accept=".txt,.pdf,.doc,.docx" style="display:none;"/>
                                Design Brief File
                            </label>
                            <div id="sketch-briefInfo" class="file-info">No file uploaded.</div>
                            <div id="sketch-briefWarning" class="warning" style="display:none">
                                PDF/DOC warning: Junk characters likely.
                            </div>
                        </div>

                        <div class="upload-row">
                            <label id="sketch-contextLabel" class="upload-label">
                                <input id="sketch-contextInput" type="file" accept="image/*" multiple style="display:none;"/>
                                Urban Context Ref. Images
                            </label>
                            <div id="sketch-contextInfo" class="file-info">No files uploaded.</div>
                        </div>

                        <div class="upload-row">
                            <label id="sketch-analysisLabel" class="upload-label">
                                <input id="sketch-analysisInput" type="file" accept=".txt,.pdf,.doc,.docx" style="display:none;"/>
                                Stylistic Analysis Report
                            </label>
                            <div id="sketch-analysisInfo" class="file-info">No file uploaded.</div>
                            <div id="sketch-analysisWarning" class="warning" style="display:none">
                                PDF/DOC warning: Junk characters likely.
                            </div>
                        </div>

                        <div class="upload-row">
                            <label id="sketch-styleImageLabel" class="upload-label">
                                <input id="sketch-styleImageInput" type="file" accept="image/*" style="display:none;"/>
                                Stylistic Reference Image
                            </label>
                            <div id="sketch-styleImageInfo" class="file-info">No file uploaded.</div>
                        </div>

                        <div class="upload-row">
                            <label id="sketch-refAnalysisLabel" class="upload-label">
                                <input id="sketch-refAnalysisInput" type="file" accept=".txt,.pdf,.doc,.docx" style="display:none;"/>
                                Reference Analysis File
                            </label>
                            <div id="sketch-refAnalysisInfo" class="file-info">No file uploaded.</div>
                            <div id="sketch-refAnalysisWarning" class="warning" style="display:none">
                                PDF/DOC warning: Junk characters likely.
                            </div>
                        </div>

                    </div>

                    <label>Canvas / Sketch Area</label>
                    <div class="canvas-wrapper">
                        <canvas id="sketch-sketchCanvas" width="800" height="600"></canvas>
                    </div>

                    <div class="controls">
                        <label class="button secondary" style="height: 45px; margin: 0;"><input id="sketch-uploadInput" type="file" accept="image/*" style="display:none;"/>Upload Sketch</label>
                        <button id="sketch-enhanceBtn" class="button primary">Enhance Sketch</button>
                        <button id="sketch-resetBtn" class="button secondary">Reset</button>
                    </div>

                    <div id="sketch-progressContainer" style="margin-top:10px; height: 5px; background: #e0e0e0; border-radius: 2px; overflow: hidden; display:none;">
                        <div id="sketch-progressBar" style="height: 100%; width: 0%; background: var(--accent); transition: width 0.1s linear;"></div>
                    </div>

                    <div style="display:flex;gap:10px;align-items:center;margin-top:20px; padding-top: 10px; border-top: 1px dashed var(--border);">
                        <strong style="margin-right:auto; font-size: 16px;">History</strong>
                        <button id="sketch-clearHistoryBtn" class="button secondary" style="display:none; height: 30px; padding: 0 10px;">Clear History</button>
                    </div>
                    <div id="sketch-history"></div>
                </section>

                <aside style="display:flex;flex-direction:column;gap:16px">
                    <div class="card">
                        <strong style="font-size: 16px;">Enhanced Result</strong>
                        <div id="sketch-results" class="results small" style="min-height: 200px;">No results yet.</div>
                        <div id="sketch-downloadContainer" style="margin-top:15px;display:none">
                            <button id="sketch-downloadBtn" class="button secondary" style="width: 100%;">Download</button>
                        </div>
                    </div>
                    <div class="card">
                        <strong style="font-size: 16px;">Bug Log</strong>
                        <div id="sketch-bugLog" class="bug-log"></div>
                        <button id="sketch-clearLogBtn" class="button secondary" style="margin-top:15px; width: 100%;">Clear Log</button>
                    </div>
                </aside>
            </div>

            <div id="sketch-imageModal"><img id="sketch-modalImg" alt="Enlarged result"></div>
        </section>

        <section id="tab-panel-socio" class="tab-panel" role="tabpanel" aria-labelledby="tab-btn-socio" aria-hidden="true">
            <div id="socio-container">
                <section class="card" aria-labelledby="socio-controlsHeading">
                    <h2 id="socio-controlsHeading">Inputs</h2>
                    <div class="row">
                        <div>
                            <label for="socio-apiKey">Gemini API Key</label>
                            <input id="socio-apiKey" type="password" placeholder="Paste your Google AI Studio API key" autocomplete="off" />
                        </div>
                        <div>
                            <label for="socio-model">Model</label>
                            <input id="socio-model" type="text" value="gemini-2.5-flash" readonly />
                        </div>
                    </div>

                    <div class="flex-group-vertical" style="margin-top:15px">
                        <div>
                            <label for="socio-projectName">Project Name (optional, used in Image Analysis)</label>
                            <input id="socio-projectName" type="text" placeholder="e.g., Waterfront Mixed-Use Hub" />
                        </div>

                        <div style="margin-top: 15px;">
                            <label for="socio-pdfInput" class="accent button" style="padding:10px 18px; cursor:pointer; margin: 0; display: inline-flex; height: auto;">Upload Project Brief PDF</label>
                            <input id="socio-pdfInput" type="file" accept=".pdf" style="display:none" onchange="socio_handlePdfUpload(event)" />
                            <span id="socio-pdfFileNameDisplay" class="filename-display muted" style="margin-left: 10px;">No file selected</span>
                        </div>
                        <div id="socio-jsonOutputDisplay" style="margin-top: 15px; display:none">
                            <h4 style="font-size: 14px; margin: 0 0 8px; font-weight: 500;">Raw PDF Transcription JSON</h4>
                            <pre id="socio-jsonOutputPre" class="json-box"></pre>
                        </div>
                    </div>

                    <div style="margin-top:15px">
                        <label for="socio-location">Location (city/area/neighborhood)</label>
                        <input id="socio-location" type="text" placeholder="e.g., Amsterdam-Noord, The Netherlands" />
                    </div>

                    <div class="row" style="margin-top:15px">
                        <div>
                            <label for="socio-perspective">Perspective</label>
                            <select id="socio-perspective" aria-label="Select analysis perspective">
                                <option value="general" selected>General Overview (Default)</option>
                                <option value="residents">Resident/User Dynamics</option>
                                <option value="business">Local Business Opportunity</option>
                                <option value="culture">Cultural & Demographic Deep Dive</option>
                                <option value="scenario">Creative Scenario Planning</option>
                            </select>
                        </div>
                        <div>
                            <label for="socio-status">Status</label>
                            <div class="status" id="socio-status"><span class="dot" id="socio-dot"></span><span id="socio-statusText">Idle</span></div>
                        </div>
                    </div>

                    <div class="btns" style="margin-top:20px">
                        <button id="socio-analyzeBtn" class="primary" disabled>Analyze Location</button>
                        <button id="socio-reanalyzeBtn" class="accent" disabled>Re-analyze with New Perspective</button>
                        <button id="socio-downloadBtn" class="accent" disabled>Download Analysis</button>
                        <button id="socio-clearBtn" class="danger">Clear</button>
                    </div>
                    <p class="muted" style="margin-top:10px; font-size: 13px;">Tip: You can press <span class="kbd" style="font-family: monospace; border: 1px solid var(--border); padding: 2px 4px; border-radius: 3px; background: #f0f0f0;">Ctrl/Cmd + Enter</span> to analyze.</p>

                    <div id="socio-personaControls" class="persona-controls-v2" aria-describedby="socio-personsHint" role="region" style="display:none; margin-top:25px; padding-top:15px; border-top:1px dashed var(--border);">
                        <h4 class="separator-label" style="margin:0; font-size: 16px; border-bottom: none;">2. Stakeholder Personas</h4>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 15px;">
                             <div style="flex-grow: 1;">
                                <label for="socio-personaType" style="margin-top: 0; color:var(--muted)">Persona Focus</label>
                                <select id="socio-personaType" aria-label="Stakeholder focus for personas" style="max-width:220px">
                                    <option value="direct" selected>Direct Stakeholders</option>
                                    <option value="indirect">Indirect Stakeholders</option>
                                </select>
                             </div>
                             <div style="flex-grow: 1;">
                                <label for="socio-personaSlider" style="margin-top: 0; color:var(--muted)">Count: <span id="socio-personaCountLabel" style="font-weight: 600;">3</span></label>
                                <input id="socio-personaSlider" type="range" min="1" max="10" value="3" style="width:100%; padding: 0;" />
                             </div>
                        </div>

                        <div class="btns" style="margin-top: 15px;">
                            <button id="socio-personasBtn" class="accent" disabled style="flex-grow: 1;">Create Personas</button>
                            <button id="socio-personasRegenBtn" class="accent" disabled style="flex-grow: 1;">Regenerate</button>
                        </div>
                        <div id="socio-personsHint" class="muted" style="margin-top: 10px; font-size: 12px;">Each click generates a fresh hidden 20-person pool, then shows a random sample. Uses last analysis as context.</div>
                    </div>
                        <section class="card" aria-labelledby="socio-controlsHeading"> <div id="socio-personaControls" class="persona-controls-v2" aria-describedby="socio-personsHint" role="region" style="display:none; margin-top:25px; padding-top:15px; border-top:1px dashed var(--border);"> </div> <div class="flex-group-vertical" style="margin-top:25px; padding-top:15px; border-top:1px dashed var(--border);"> <h4 class="separator-label" style="margin:0; font-size: 16px; border-bottom: none;">3. Architectural Render Input</h4> <div id="socio-aipraaInput" style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; margin-top: 15px;"> <label for="socio-imageUpload" class="accent button" style="padding:10px 18px; cursor:pointer; margin: 0; height: 40px;">Upload Architectural Render</label> <input type="file" id="socio-imageUpload" accept=".jpg, .jpeg, .png" style="display:none;" /> <button id="socio-analyzeButton" class="primary" disabled style="height: 40px;"> <svg id="socio-spinner" class="spinner -ml-1 mr-2 h-4 w-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Analyze Render </button> </div> <div id="socio-statusMessageContainer" style="margin-bottom: 10px;"> <div id="socio-statusMessage" class="status-message py-2 px-4 rounded-lg text-sm font-medium transition-all duration-300 mb-4" style="padding: 8px 12px;"> Ready to begin. </div> </div> </div> <div id="socio-opinionGeneratorControls" class="flex-group-vertical" style="margin-top:25px; padding-top:15px; border-top:1px dashed var(--border);"> </div></section>
                    <div id="socio-opinionGeneratorControls" class="flex-group-vertical" style="margin-top:25px; padding-top:15px; border-top:1px dashed var(--border);">
                        <h4 class="separator-label" style="margin:0; font-size: 16px; border-bottom: none;">4. Opinion Generator</h4>

                        <div class="row" style="grid-template-columns: 1.5fr 1fr; margin-top: 15px; align-items: flex-end;">
                            <div>
                                <label for="socio-personaSelector" style="margin-top: 0;">Select Persona for Opinion</label>
                                <select id="socio-personaSelector" aria-label="Select a generated persona">
                                    <option value="" disabled selected>No Personas Available</option>
                                </select>
                            </div>
                            <div style="align-self: flex-end;">
                                <button id="socio-generateOpinionBtn" class="primary" disabled style="width:100%; height: 45px; padding: 0 12px;">
                                    <svg id="socio-opinionSpinner" class="spinner -ml-1 mr-2 h-4 w-4 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                    Create Persona Opinions
                                </button>
                            </div>
                        </div>
                        <p class="muted" style="margin-top:10px; font-size: 13px;">Requires: PDF Brief, Persona Generation, and Render Analysis outputs.</p>
                    </div>

                </section>

                <section class="card" aria-labelledby="socio-resultsHeading">
                    <h2 id="socio-resultsHeading">Analysis Results</h2>

                    <h3 class="separator-label">1. Socio-Cultural Location Analysis</h3>
                    <div id="socio-results" class="results" aria-live="polite" aria-busy="false">
                        <div class="muted" style="text-align:center; padding:12px 0;">
                            Run a location analysis to see results here.
                        </div>
                    </div>

                    <h3 class="separator-label">2. Stakeholder Personas</h3>
                    <div id="socio-personaMount" class="persona-grid multi" aria-live="polite" aria-busy="false"></div>
                    <div id="socio-personasJsonLabel" class="separator-label" style="display:none; margin-bottom: 8px;">Displayed Personas Â· JSON</div>
                    <div id="socio-personasJsonBox" class="json-box" style="display:none; max-height: 200px;"></div>

                    <div id="socio-aipraaSection" class="render-analysis-container">
                        <h3 class="separator-label">3. Architectural Render Analysis (AIPRAA)</h3>


                    

                        <div id="socio-imagePreviewContainer" class="image-preview-section" style="display:none; margin-bottom: 20px;">
                            <p class="muted" style="margin: 0 0 8px;">Image Preview:</p>
                            <img id="socio-imagePreview" alt="Image Preview">
                        </div>

                        <div id="socio-reportOutput" class="space-y-6 text-gray-700">
                            <div id="socio-initialReportPrompt" class="muted" style="text-align:center; padding:12px 0;">
                                Upload an image and click "Analyze Render" to generate a detailed report here.
                            </div>

                            <div id="socio-analysisReport" style="display:none; margin-top: 16px;">

                                <h4 class="render-report-heading" style="font-weight: 500; font-size: 15px; color: var(--accent); margin-top: 0;">1. Architectural Composition & Scale</h4>
                                <p class="muted">Focal Point & Massing:</p>
                                <div id="socio-comp-focal" class="ai-response-pre">Analysis pending...</div>
                                <p class="muted" style="margin-top: 12px;">Scale Indicators:</p>
                                <div id="socio-comp-scale" class="ai-response-pre">Analysis pending...</div>
                                <p class="muted" style="margin-top: 12px;">Relationship to Ground:</p>
                                <div id="socio-comp-ground" class="ai-response-pre">Analysis pending...</div>

                                <h4 class="render-report-heading" style="font-weight: 500; font-size: 15px; color: var(--accent); margin-top: 20px;">2. Materiality & Fenestration</h4>
                                <p class="muted">Dominant Materials:</p>
                                <div id="socio-mat-materials" class="ai-response-pre">Analysis pending...</div>
                                <p class="muted" style="margin-top: 12px;">Window/FaÃ§ade System:</p>
                                <div id="socio-mat-facade" class="ai-response-pre">Analysis pending...</div>
                                <p class="muted" style="margin-top: 12px;">Key Features & Detailing:</p>
                                <div id="socio-mat-detailing" class="ai-response-pre">Analysis pending...</div>

                                <h4 class="render-report-heading" style="font-weight: 500; font-size: 15px; color: var(--accent); margin-top: 20px;">3. Context, Atmosphere & Lighting</h4>
                                <p class="muted">Contextual Integration:</p>
                                <div id="socio-context-integration" class="ai-response-pre">Analysis pending...</div>
                                <p class="muted" style="margin-top: 12px;">Lighting & Shadow Play:</p>
                                <div id="socio-context-lighting" class="ai-response-pre">Analysis pending...</div>
                                <p class="muted" style="margin-top: 12px;">Atmospheric Elements:</p>
                                <div id="socio-context-elements" class="ai-response-pre">Analysis pending...</div>

                                <h4 class="render-report-heading" style="font-weight: 500; font-size: 15px; color: var(--accent); margin-top: 20px;">4. Standout Visuals & Narrative Cues</h4>
                                <p class="muted">Implied Function & Use:</p>
                                <div id="socio-narrative-function" class="ai-response-pre">Analysis pending...</div>
                                <p class="muted" style="margin-top: 12px;">"Staging" Elements:</p>
                                <div id="socio-narrative-staging" class="ai-response-pre">Analysis pending...</div>
                                <p class="muted" style="margin-top: 12px;">Intended Read:</p>
                                <div id="socio-narrative-read" class="ai-response-pre">Analysis pending...</div>

                                <h4 class="render-report-heading" style="font-weight: 500; font-size: 15px; color: var(--accent); margin-top: 20px;">Most Striking Features (Top 3)</h4>
                                <ul class="striking-list" style="list-style: none; padding-left: 0; margin-top: 8px;">
                                    <li id="socio-striking-1" class="ai-response-pre" style="margin-bottom: 8px;">Analysis pending...</li>
                                    <li id="socio-striking-2" class="ai-response-pre" style="margin-bottom: 8px;">Analysis pending...</li>
                                    <li id="socio-striking-3" class="ai-response-pre">Analysis pending...</li>
                                </ul>

                                <h4 class="render-report-heading" style="font-weight: 500; font-size: 15px; color: var(--accent); margin-top: 20px;">Raw AI Output (for Debugging)</h4>
                                <pre id="socio-rawAiOutput" class="json-box" style="max-height: 200px;">Waiting for successful analysis...</pre>
                            </div>
                        </div>
                    </div>

                    <div id="socio-opinionOutputContainer" class="render-analysis-container">
                        <h3 class="separator-label">4. Persona Opinion & Feasibility</h3>
                        <div id="socio-opinionOutputDisplay" style="display:none;">
                            <h4 id="socio-opinionPersonaName" style="font-size: 16px; margin: 0 0 15px; font-weight: 500;">Opinion for: [Persona Name]</h4>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <p class="muted" style="color:var(--ok); margin:0 0 8px; font-size: 14px; font-weight: 500;">Pros</p>
                                    <ul id="socio-opinionProsList" class="opinion-list pros"></ul>
                                </div>
                                <div>
                                    <p class="muted" style="color:var(--danger); margin:0 0 8px; font-size: 14px; font-weight: 500;">Cons</p>
                                    <ul id="socio-opinionConsList" class="opinion-list cons"></ul>
                                </div>
                            </div>
                        </div>
                        <div id="socio-initialOpinionPrompt" class="muted" style="text-align:center; padding:12px 0;">
                            Select a persona and click "Create Persona Opinions" after running Tools 1, 2, and 3.
                        </div>
                    </div>

                    <h2 style="margin-top:25px; font-size: 20px; font-weight: 500; border-top: 1px dashed var(--border); padding-top: 15px;">Debug Log</h2>
                    <div id="socio-log" class="log" aria-live="polite"></div>
                </section>
            </div>
        </section>
    </main>



    <script>
        // --- 1. CORE TAB SWITCHER LOGIC ---

        const tabList = document.getElementById('tab-list');
        const tabButtons = Array.from(tabList.querySelectorAll('.tab-button'));
        const tabPanels = Array.from(document.querySelectorAll('.tab-panel'));
        const tabData = {
            'tab-btn-sketch': { panelId: 'tab-panel-sketch', initialized: false, initFunc: initSketchEnhancer },
            'tab-btn-socio': { panelId: 'tab-panel-socio', initialized: false, initFunc: initSocioCultural },
        };

        let activeTabId = 'tab-btn-sketch';

        /**
         * Switches the active tab and initializes content if necessary.
         * @param {string} newTabId - The ID of the tab button to activate.
         */
        function switchTab(newTabId) {
            if (activeTabId === newTabId) return;

            // 1. Update ARIA and visibility
            tabButtons.forEach(btn => {
                const isSelected = btn.id === newTabId;
                btn.setAttribute('aria-selected', isSelected);
                btn.setAttribute('tabindex', isSelected ? '0' : '-1');
            });

            tabPanels.forEach(panel => {
                const isVisible = panel.id === tabData[newTabId].panelId;
                panel.setAttribute('aria-hidden', !isVisible);
                panel.style.display = isVisible ? 'block' : 'none';
            });

            activeTabId = newTabId;

            // 2. Lazy Initialization
            const tabInfo = tabData[newTabId];
            if (!tabInfo.initialized) {
                tabInfo.initFunc();
                tabInfo.initialized = true;
            }
        }

        /**
         * Sets up event listeners for the tab system.
         */
        function setupTabListeners() {
            tabList.addEventListener('click', (e) => {
                const target = e.target.closest('.tab-button');
                if (target) switchTab(target.id);
            });

            tabList.addEventListener('keydown', (e) => {
                let index = tabButtons.findIndex(btn => btn.id === activeTabId);
                let newIndex = index;

                switch (e.key) {
                    case 'ArrowLeft':
                        newIndex = (index - 1 + tabButtons.length) % tabButtons.length;
                        break;
                    case 'ArrowRight':
                        newIndex = (index + 1) % tabButtons.length;
                        break;
                    case 'Home':
                        newIndex = 0;
                        break;
                    case 'End':
                        newIndex = tabButtons.length - 1;
                        break;
                    default:
                        return; // Do nothing for other keys
                }

                if (newIndex !== index) {
                    e.preventDefault();
                    switchTab(tabButtons[newIndex].id);
                    tabButtons[newIndex].focus();
                }
            });
        }

        // --- 2. SKETCH ENHANCER INITIALIZATION & CODE ADAPTATION ---
        
        // Original Sketch Enhancer code, adapted for 'sketch-' prefix
        // All ID references (e.g., 'sketchCanvas') and function names (e.g., 'sketch_init') must be updated.

        function initSketchEnhancer() {
            // REFERENCES (PREFIIXED)
            const canvas=document.getElementById('sketch-sketchCanvas'),ctx=canvas.getContext('2d',{willReadFrequently:true});
            const uploadInput=document.getElementById('sketch-uploadInput'),enhanceBtn=document.getElementById('sketch-enhanceBtn'),resetBtn=document.getElementById('sketch-resetBtn');
            const providerSelect=document.getElementById('sketch-providerSelect'),apiKeyInput=document.getElementById('sketch-apiKeyInput');
            const resultsEl=document.getElementById('sketch-results'),bugLogEl=document.getElementById('sketch-bugLog'),clearLogBtn=document.getElementById('sketch-clearLogBtn');
            const progressContainer=document.getElementById('sketch-progressContainer'),progressBar=document.getElementById('sketch-progressBar');
            const downloadBtn=document.getElementById('sketch-downloadBtn'),downloadContainer=document.getElementById('sketch-downloadContainer'),historyEl=document.getElementById('sketch-history');
            const imageModal=document.getElementById('sketch-imageModal'),modalImg=document.getElementById('sketch-modalImg');
            const promptInput=document.getElementById('sketch-promptInput');
            const clearHistoryBtn = document.getElementById('sketch-clearHistoryBtn');
            // --- Mode Toggle State ---
            let creativeMode = false; // false = Studio (default), true = Creative
            const modeToggleBtn = document.getElementById('sketch-modeToggleBtn');

            modeToggleBtn.addEventListener('click', () => {
                creativeMode = !creativeMode;
                if (creativeMode) {
                    modeToggleBtn.textContent = 'Mode: Creative ðŸŽ¨';
                    modeToggleBtn.classList.add('active');
                    sketch_logBug('INFO', 'Switched to Creative Mode.', 'User Mode Toggle');
                } else {
                    modeToggleBtn.textContent = 'Mode: Studio ðŸ§±';
                    modeToggleBtn.classList.remove('active');
                    sketch_logBug('INFO', 'Switched to Studio Mode.', 'User Mode Toggle');
                }
            });

            // Design Brief References
            const briefInput=document.getElementById('sketch-briefInput');
            const briefInfo=document.getElementById('sketch-briefInfo');
            const briefLabel=document.getElementById('sketch-briefLabel');
            const briefWarning=document.getElementById('sketch-briefWarning');

            // Urban Context References
            const contextInput=document.getElementById('sketch-contextInput');
            const contextInfo=document.getElementById('sketch-contextInfo');
            const contextLabel=document.getElementById('sketch-contextLabel');

            // Stylistic Analysis References
            const analysisInput=document.getElementById('sketch-analysisInput');
            const analysisInfo=document.getElementById('sketch-analysisInfo');
            const analysisLabel=document.getElementById('sketch-analysisLabel');
            const analysisWarning=document.getElementById('sketch-analysisWarning');

            // Stylistic Image Reference
            const styleImageInput = document.getElementById('sketch-styleImageInput');
            const styleImageInfo = document.getElementById('sketch-styleImageInfo');
            const styleImageLabel = document.getElementById('sketch-styleImageLabel');
            let styleImageBase64 = null;

            // Reference Analysis References
            const refAnalysisInput=document.getElementById('sketch-refAnalysisInput');
            const refAnalysisInfo=document.getElementById('sketch-refAnalysisInfo');
            const refAnalysisLabel=document.getElementById('sketch-refAnalysisLabel');
            const refAnalysisWarning=document.getElementById('sketch-refAnalysisWarning');

            /* STATE FOR DATA */
            let designBriefContent = '';
            let contextImagesBase64 = [];
            let analysisReportContent = '';
            let refAnalysisContent = '';
            let currentSketchFile = null;
            const TEXT_CHAR_LIMIT = 4000;


            /* BUG LOG (PREFIIXED) */
            function sketch_logBug(type, desc, context = '') {
                const now = new Date();
                const ts = now.toLocaleTimeString() + '.' + String(now.getMilliseconds()).padStart(3, '0');
                const node = document.createElement('div');
                node.className = 'log-entry';
                node.innerHTML = `
                    <div>
                        <strong>${type.toUpperCase()}</strong>
                        [<span style="color:#a8a8a8">${ts}</span>] â€”
                        <span style="color:var(--muted)">${context}</span>
                    </div>
                    <div class="small" style="margin-top:6px;color:var(--text);white-space:pre-wrap;">${sketch_escapeHtml(desc)}</div>`;
                bugLogEl.prepend(node);
            }
            function sketch_escapeHtml(s){return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}
            clearLogBtn.addEventListener('click',()=>{bugLogEl.innerHTML='';sketch_logBug('INFO', 'Log cleared by user.', 'UI Action');});


            /* CANVAS AND SKETCH INPUT (PREFIIXED) */
            function clearCanvas(){ctx.fillStyle='#fff';ctx.fillRect(0,0,canvas.width,canvas.height);ctx.lineWidth=3;ctx.lineCap='round';ctx.strokeStyle='#000';}
            clearCanvas();
            let drawing=false,last={x:0,y:0};
            canvas.addEventListener('pointerdown',e=>{
                drawing=true;
                const r=canvas.getBoundingClientRect();
                last.x=e.clientX-r.left;
                last.y=e.clientY-r.top;
            });
            canvas.addEventListener('pointermove',e=>{
                if(!drawing)return;
                const r=canvas.getBoundingClientRect();
                const x=e.clientX-r.left,y=e.clientY-r.top;
                ctx.beginPath();
                ctx.moveTo(last.x,last.y);
                ctx.lineTo(x,y);
                ctx.stroke();
                last.x=x;
                last.y=y;
            });
            window.addEventListener('pointerup',()=>drawing=false);
            uploadInput.addEventListener('change',ev=>{
                const f=ev.target.files?.[0];
                if(!f) return;
                currentSketchFile = f;
                sketch_logBug('INFO', `Sketch file loaded: ${f.name}.`, 'Sketch Upload');
                const img=new Image();
                img.onload=()=>{
                    const scale=Math.min(canvas.width/img.width,canvas.height/img.height);
                    const w=img.width*scale,h=img.height*scale;
                    clearCanvas();
                    ctx.drawImage(img,0,0,img.width,img.height,(canvas.width-w)/2,(canvas.height-h)/2,w,h);
                };
                img.src=URL.createObjectURL(f);
                uploadInput.value = '';
            });

            /* GENERIC TEXT FILE HANDLER (BRIEF, ANALYSIS, REF ANALYSIS) (PREFIIXED) */
            function sketch_handleTextFileUpload(e, label, info, warning, contentVariable) {
                const f = e.target.files?.[0];
                const charLimit = TEXT_CHAR_LIMIT;
                const logContext = label.textContent.trim();

                warning.style.display = 'none';
                label.classList.remove('active');

                if (!f) {
                    window[contentVariable] = '';
                    info.textContent = 'No file uploaded.';
                    return;
                }

                info.textContent = `File: ${f.name}`;
                label.classList.add('active');

                const isTextFile = f.name.toLowerCase().endsWith('.txt') || f.type === 'text/plain';
                if (!isTextFile) {
                    warning.style.display = 'block';
                    warning.textContent = 'PDF/DOC warning: Junk characters likely.';
                    sketch_logBug('WARNING', `Non-plain text file uploaded. Content extraction may include formatting junk.`, logContext + ' Validation');
                }

                try {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // Use a shared variable in the closure scope, not window[contentVariable]
                        if (contentVariable === 'designBriefContent') designBriefContent = e.target.result;
                        else if (contentVariable === 'analysisReportContent') analysisReportContent = e.target.result;
                        else if (contentVariable === 'refAnalysisContent') refAnalysisContent = e.target.result;

                        const content = e.target.result;
                        if (content.length > charLimit) {
                            sketch_logBug('WARNING', `Content exceeded ${charLimit} characters and will be truncated.`, logContext + ' Processing');
                        }
                        sketch_logBug('SUCCESS', `${logContext} content read.`, `Length: ${content.length}`);
                    };
                    reader.onerror = () => {
                        if (contentVariable === 'designBriefContent') designBriefContent = '';
                        else if (contentVariable === 'analysisReportContent') analysisReportContent = '';
                        else if (contentVariable === 'refAnalysisContent') refAnalysisContent = '';

                        info.textContent = `Error reading file.`;
                        label.classList.remove('active');
                        sketch_logBug('ERROR', `Error reading file.`, logContext + ' Error');
                    };
                    reader.readAsText(f);

                } catch (e) {
                    sketch_logBug('FATAL_ERR', `Unhandled error during upload: ${e.message}`, logContext + ' Upload');
                    label.classList.remove('active');
                }
                e.target.value = '';
            }

            // Event Listeners for all text files (PREFIIXED)
            briefInput.addEventListener('change', (e) => sketch_handleTextFileUpload(e, briefLabel, briefInfo, briefWarning, 'designBriefContent'));
            analysisInput.addEventListener('change', (e) => sketch_handleTextFileUpload(e, analysisLabel, analysisInfo, analysisWarning, 'analysisReportContent'));
            refAnalysisInput.addEventListener('change', (e) => sketch_handleTextFileUpload(e, refAnalysisLabel, refAnalysisInfo, refAnalysisWarning, 'refAnalysisContent'));


            /* CONTEXT IMAGE HANDLER (PREFIIXED) */
            contextInput.addEventListener('change', async ev => {
                const files = Array.from(ev.target.files || []);
                contextImagesBase64 = [];
                contextLabel.classList.remove('active');

                if (files.length === 0) {
                    contextInfo.textContent = 'No files uploaded.';
                    sketch_logBug('WARNING', 'No context files selected.', 'Context Upload');
                    return;
                }

                contextLabel.classList.add('active');
                contextInfo.textContent = `${files.length} file(s) selected. Processing...`;

                const errors = [];
                const readers = files.map(file => {
                    return new Promise((resolve, reject) => {
                        if (!file.type.startsWith('image/')) {
                            errors.push(`File ${file.name} is not an image.`);
                            return resolve();
                        }

                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const base64Data = e.target.result.split(',')[1];
                            contextImagesBase64.push({ mime: file.type, data: base64Data });
                            resolve();
                        };
                        reader.onerror = () => {
                            errors.push(`Failed to read file: ${file.name}`);
                            reject(new Error(`Read error on ${file.name}`));
                        };
                        reader.readAsDataURL(file);
                    });
                });

                try {
                    await Promise.all(readers);
                    contextInfo.textContent = `${contextImagesBase64.length} context image(s) processed.`;
                    sketch_logBug('SUCCESS', `${contextImagesBase64.length} images processed.`, 'Context Upload');
                    if(errors.length) sketch_logBug('WARNING', `${errors.length} file(s) skipped/failed.`, errors.join('\n'));

                } catch (e) {
                    sketch_logBug('FATAL_ERR', `Error during context file processing: ${e.message}`, 'Context Upload');
                    contextLabel.classList.remove('active');
                }
                contextInput.value = '';
            });

            /* STYLISTIC IMAGE HANDLER (PREFIIXED) */
            styleImageInput.addEventListener('change', async ev => {
                const file = ev.target.files?.[0];
                styleImageLabel.classList.remove('active');
                styleImageBase64 = null;

                if (!file) {
                    styleImageInfo.textContent = 'No file uploaded.';
                    sketch_logBug('WARNING', 'No stylistic image selected.', 'Stylistic Image Upload');
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    styleImageInfo.textContent = 'Invalid file type.';
                    sketch_logBug('ERROR', `Invalid stylistic image type: ${file.name}`, 'Stylistic Image Upload');
                    return;
                }

                styleImageLabel.classList.add('active');
                styleImageInfo.textContent = `File: ${file.name}`;

                const reader = new FileReader();
                reader.onload = (e) => {
                    styleImageBase64 = e.target.result.split(',')[1];
                    sketch_logBug('SUCCESS', `Stylistic image processed: ${file.name}`, 'Stylistic Image Upload');
                };
                reader.onerror = () => {
                    sketch_logBug('ERROR', `Failed to read stylistic image: ${file.name}`, 'Stylistic Image Upload');
                };
                reader.readAsDataURL(file);
                styleImageInput.value = '';
            });


            /* Helper: Archive current result into history (used when re-enhancing) (PREFIIXED) */
            function sketch_archiveCurrentResult() {
                try {
                    const existingImg = resultsEl.querySelector('img');
                    if (existingImg && existingImg.src) {
                        const item = document.createElement('div');
                        item.className = 'history-item';

                        const imgClone = document.createElement('img');
                        imgClone.src = existingImg.src;
                        imgClone.title = (new Date()).toLocaleString();
                        imgClone.onclick = () => { modalImg.src = imgClone.src; imageModal.style.display = 'flex'; };
                        item.appendChild(imgClone);

                        const dl = document.createElement('button');
                        dl.textContent = 'Download';
                        dl.className = 'button secondary';
                        dl.style.marginTop = '8px';
                        dl.style.height = '30px';
                        dl.style.padding = '0 8px';
                        dl.onclick = () => { const a = document.createElement('a'); a.href = imgClone.src; a.download = `archived_${Date.now()}.png`; a.click(); };
                        item.appendChild(dl);

                        historyEl.prepend(item);
                        sketch_logBug('SUCCESS', 'Previous result archived automatically.', 'Auto-Archive');

                        sketch_updateClearHistoryVisibility();
                    }
                } catch (e) {
                    sketch_logBug('ERROR', `Failed to archive current result: ${e.message}`, 'Auto-Archive');
                }
            }

            /* RESET & HISTORY (PREFIIXED) */
            resetBtn.addEventListener('click',()=>{
                if(resultsEl.innerHTML.trim()&&!resultsEl.innerHTML.includes('No results')){
                    const item=document.createElement('div');
                    item.className='history-item';
                    const resultContent = resultsEl.cloneNode(true);
                    const dlContainer = resultContent.querySelector('#sketch-downloadContainer'); // Use prefixed ID
                    if (dlContainer) dlContainer.remove();
                    
                    const imgInResult = resultsEl.querySelector('img');
                    if(imgInResult){
                        const imgClone = document.createElement('img');
                        imgClone.src = imgInResult.src;
                        imgClone.title = (new Date()).toLocaleString();
                        imgClone.onclick = () => { modalImg.src = imgClone.src; imageModal.style.display = 'flex'; };
                        item.appendChild(imgClone);
                    } else {
                         // Fallback for non-image result (e.g. error message)
                        const fallbackText = document.createElement('div');
                        fallbackText.className = 'small';
                        fallbackText.textContent = 'Non-image result';
                        item.appendChild(fallbackText);
                    }

                    const dl=document.createElement('button');
                    dl.textContent='Download';
                    dl.className='button secondary';
                    dl.style.marginTop='8px';
                    dl.style.height = '30px';
                    dl.style.padding = '0 8px';
                    dl.onclick=()=>downloadBtn.onclick();
                    item.appendChild(dl);

                    historyEl.prepend(item);
                    sketch_logBug('SUCCESS', 'Previous result added to history.', 'History');

                    sketch_updateClearHistoryVisibility();
                }

                clearCanvas();
                resultsEl.innerHTML='No results yet.';
                downloadContainer.style.display='none';
                currentSketchFile = null;
                designBriefContent = '';
                analysisReportContent = '';
                refAnalysisContent = '';
                contextImagesBase64 = [];
                styleImageBase64 = null;
                styleImageInfo.textContent = 'No file uploaded.';
                styleImageLabel.classList.remove('active');

                briefInfo.textContent = 'No file uploaded.';
                analysisInfo.textContent = 'No file uploaded.';
                refAnalysisInfo.textContent = 'No file uploaded.';
                contextInfo.textContent = 'No files uploaded.';

                briefLabel.classList.remove('active');
                analysisLabel.classList.remove('active');
                refAnalysisLabel.classList.remove('active');
                contextLabel.classList.remove('active');

                briefWarning.style.display = 'none';
                analysisWarning.style.display = 'none';
                refAnalysisWarning.style.display = 'none';

                sketch_logBug('INFO', 'Canvas, results, and file inputs cleared.', 'Canvas Reset');
            });

            /* ENHANCE (API CALLS) (PREFIIXED) */
            function getCanvasBase64(){return canvas.toDataURL('image/png').split(',')[1];}

            enhanceBtn.addEventListener('click',async()=>{
                const apiKey=apiKeyInput.value.trim();
                if(!apiKey){
                    alert('Please paste your API key');
                    sketch_logBug('WARNING', 'Enhance failed: API key is missing.', 'Validation');
                    return;
                }

                sketch_archiveCurrentResult();

                const provider=providerSelect.value;
                sketch_logBug('INFO', 'Enhance process started.', `Provider: ${provider}`);

                enhanceBtn.disabled=true;
                progressContainer.style.display='block';
                progressBar.style.width='0%';
                resultsEl.innerHTML='Processing...';
                downloadContainer.style.display='none';

                try{
                    const sketchB64=getCanvasBase64();

                    let prompt = "";

                    // 1. STYLISTIC ANALYSIS (Highest Priority)
                    if(analysisReportContent){
                        const truncatedAnalysis = analysisReportContent.substring(0, TEXT_CHAR_LIMIT);
                        prompt+=`PRIMARY STYLE GUIDE: Apply the following detailed stylistic analysis to the final output. This report breaks down the required artistic style (line work, shading, color, texture). You must adhere to these components: ${truncatedAnalysis}`;
                    } else {
                         prompt+=`Enhance this architectural sketch, following the input instructions below to define the style.`;
                    }

                    // 2. USER PROMPT (Mid-High Priority)
                    const userPrompt = promptInput.value.trim();
                    if(userPrompt){
                        prompt+=` | USER PROMPT: Apply these high-level descriptive terms (materials, color, mood): ${userPrompt}`;
                    }

                    // 3. DESIGN BRIEF (Mid Priority - Functional details)
                    if(designBriefContent){
                        const truncatedBrief = designBriefContent.substring(0, TEXT_CHAR_LIMIT);
                        prompt+=` | DESIGN BRIEF: Incorporate these functional design details, materials, and constraints. If the brief contains junk characters from a non-text file, please ignore them: ${truncatedBrief}`;
                    }

                    // 4. REFERENCE ANALYSIS (Lowest Priority - Benchmark)
                    if(refAnalysisContent){
                        const truncatedRefAnalysis = refAnalysisContent.substring(0, TEXT_CHAR_LIMIT);
                        prompt+=` | REFERENCE ANALYSIS: Use this previous analysis as a benchmark and point of comparison for iterative improvements: ${truncatedRefAnalysis}`;
                    }

                    sketch_logBug('INFO', `Final prompt length: ${prompt.length} characters.`, 'Prompt Construction');


                    if(provider==='freepik' || provider==='openai'){

                        if(contextImagesBase64.length > 0) {
                             sketch_logBug('WARNING', 'Context images were uploaded but IGNORED. Only Gemini supports multi-image input with this code.', `Provider: ${provider}`);
                        }

                        if(provider==='freepik'){
                            const resp=await fetch('https://api.freepik.com/v1/ai/mystic',{
                                method:'POST',
                                headers:{'Content-Type':'application/json','x-freepik-api-key':apiKey},
                                body:JSON.stringify({prompt,structure_reference:sketchB64,structure_strength:50,resolution:"2k",aspect_ratio:"widescreen_16_9"})
                            });
                            const json=await resp.json();
                            if(resp.status !== 200){
                                throw new Error(`API Error ${resp.status}: ${json.message || 'Unknown error'}`);
                            }
                            const taskId=json.data?.task_id;
                            sketch_logBug('INFO', `Freepik task ID received: ${taskId}. Starting polling...`, 'Freepik API');

                            let url=null;
                            for(let i=0;i<60;i++){
                                await new Promise(r=>setTimeout(r,2000));
                                progressBar.style.width=`${((i+1)/60*100).toFixed(1)}%`;
                                const st=await fetch(`https://api.freepik.com/v1/ai/mystic/${taskId}`,{headers:{'x-freepik-api-key':apiKey}});
                                const js=await st.json();
                                if(js.data?.generated?.length){
                                    url=js.data.generated[0];
                                    sketch_logBug('SUCCESS', 'Freepik image generated and retrieved.', 'Freepik API');
                                    break;
                                }
                            }
                            if(url)sketch_showResult(url);else resultsEl.innerHTML='<span style="color:var(--danger)">Timeout, no image. Check bug log for details.</span>';
                        } else if(provider==='openai'){
                            const resp=await fetch('https://api.openai.com/v1/images/edits',{
                                method:'POST',
                                headers:{'Authorization':`Bearer ${apiKey}`,'Content-Type':'application/json'},
                                body:JSON.stringify({image:`data:image/png;base64,${sketchB64}`,prompt,n:1,size:"1024x1024"})
                            });
                            const j=await resp.json();
                            if(j.error){
                                throw new Error(`OpenAI Error: ${j.error.message}`);
                            }
                            if(j.data?.length){
                                sketch_showResult(j.data[0].url);
                                sketch_logBug('SUCCESS', 'OpenAI image URL received.', 'OpenAI API');
                            } else {
                                 resultsEl.innerHTML='<span style="color:var(--danger)">No image or API error. Check bug log.</span>';
                                 sketch_logBug('ERROR', JSON.stringify(j, null, 2), 'OpenAI API Response');
                            }
                        }
                    } else if(provider==='gemini'){
                        sketch_logBug('INFO', `Gemini prompt includes ${contextImagesBase64.length} context images.`, 'Gemini API');

                        const GEMINI_ENDPOINT = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent';

                        let combinedPrompt = '';
                        let generation_config = {};

                        if (creativeMode) {
                            const creativePreamble = `
You are an imaginative architectural visualization assistant.
Create a compelling, atmospheric rendering from the provided sketch.
Focus on materiality, light, and spatial atmosphere.
Interpret the prompt with artistic freedom and intuition.
`;
                            combinedPrompt = creativePreamble + "\n\n" + prompt;
                            generation_config = {
                                response_modalities: ["IMAGE", "TEXT"],
                                temperature: 0.8,
                            };
                        } else {
                            combinedPrompt = prompt;
                            generation_config = {
                                response_modalities: ["IMAGE"],
                                temperature: 0.3,
                            };
                        }

                        const parts = [
                          { inline_data: { mime_type: 'image/png', data: sketchB64 } },

                          ...(styleImageBase64
                            ? [{ inline_data: { mime_type: 'image/png', data: styleImageBase64 } }]
                            : []),

                          ...contextImagesBase64.map(img => ({ inline_data: { mime_type: img.mime, data: img.data } })),

                          { text: combinedPrompt }
                        ];

                        const body = {
                          contents: [{ parts }],
                          generation_config
                        };


                        const resp=await fetch(`${GEMINI_ENDPOINT}?key=${apiKey}`,{
                            method:'POST',
                            headers:{'Content-Type':'application/json'},
                            body:JSON.stringify(body)
                        });

                        const json=await resp.json();
                        if(json.error){
                            throw new Error(`Gemini Error: ${json.error.message}`);
                        }

                        const found=sketch_extractImages(json);
                        if(found.length){
                            const f=found[0];
                            const dataUrl=f.data.startsWith('data:')?f.data:`data:${f.mime};base64,${f.data}`;
                            sketch_showResult(dataUrl);
                            sketch_logBug('SUCCESS', 'Gemini image data received and displayed.', 'Gemini API');
                        }else{
                             resultsEl.innerHTML='<span style="color:var(--danger)">No Gemini image found in response. Check bug log.</span>';
                             sketch_logBug('ERROR', JSON.stringify(json, null, 2), 'Gemini API Response');
                        }
                    }
                }catch(e){
                    resultsEl.innerHTML=`<span style="color:var(--danger)">Error: ${sketch_escapeHtml(e.message)}</span>`;
                    sketch_logBug('FATAL_ERR', e.stack || e.message, `Enhance Call | Provider: ${provider}`);
                }
                finally{
                    enhanceBtn.disabled=false;
                    progressContainer.style.display='none';
                }
            });

            /* SHOW RESULT (PREFIIXED) */
            function sketch_showResult(url){
                resultsEl.innerHTML='';
                const img=document.createElement('img');
                img.src=url;
                img.style.maxWidth='100%';
                img.style.cursor='zoom-in';
                img.onclick=()=>{modalImg.src=url;imageModal.style.display='flex';};
                resultsEl.appendChild(img);
                downloadBtn.onclick=()=>{const a=document.createElement('a');a.href=url;a.download='enhanced.png';a.click();};
                downloadContainer.style.display='block';
            }

            /* EXTRACT IMAGES (PREFIIXED) */
            function sketch_extractImages(obj){
                const f=[];
                const seen=new WeakSet();
                function v(x){
                    if(!x)return;
                    if(typeof x==='string'){
                        if(/^data:image/.test(x))f.push({mime:'image/png',data:x});
                        else if(x.length>400)f.push({mime:'image/png',data:x});
                        return;
                    }
                    if(typeof x!=='object')return;
                    if(seen.has(x))return;
                    seen.add(x);
                    if(x.inline_data?.data)f.push({mime:x.inline_data.mime_type||'image/png',data:x.inline_data.data});
                    for(const k in x)try{v(x[k]);}catch{}
                }
                v(obj);
                return f;
            }
            imageModal.onclick=()=>{imageModal.style.display='none';modalImg.src='';};

            /* Clear History button behavior: appears only when history has items (PREFIIXED) */
            function sketch_updateClearHistoryVisibility(){
                const hasItems = historyEl.querySelector('.history-item') !== null;
                clearHistoryBtn.style.display = hasItems ? 'inline-flex' : 'none';
            }
            clearHistoryBtn.addEventListener('click', ()=>{
                if(!confirm('Clear all saved history images?')) return;
                historyEl.innerHTML = '';
                sketch_updateClearHistoryVisibility();
                sketch_logBug('INFO', 'User cleared history.', 'History');
            });

            // Final initialization calls
            clearCanvas();
            sketch_updateClearHistoryVisibility();
        }

        // --- 3. SOCIO-CULTURAL SITE ANALYSIS INITIALIZATION & CODE ADAPTATION ---

        // Original TWEAK7b code, adapted for 'socio-' prefix and encapsulated state/functions.
        // All original global functions must be renamed (e.g., 'handlePdfUpload' -> 'socio_handlePdfUpload').

        function initSocioCultural() {
            // === Configuration ===
            const MODEL_ID = 'gemini-2.5-flash';
            const TRANSCRIPTION_MODEL_ID = 'gemini-2.5-flash-preview-05-20';
            const OPINION_MODEL_ID = 'gemini-2.5-flash-preview-05-20';
            const ENDPOINT = (apiKey, model) => `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${encodeURIComponent(apiKey)}`;

            // === State ===
            const state = {
                history: [], // { ts, location, perspectiveKey, perspectiveLabel, prompt, text }
                lastLocation: '',
                _lastPoolMeta: null,
                imagePart: null, // Global variable for the AIPRAA image part
                pdfText: null, // NEW: Store the transcribed PDF text
                pdfFileName: null, // NEW: Store the name of the uploaded PDF
                processing: false, // Global processing flag for all operations
                lastRenderedPersonas: [], // NEW: Store the personas output by Tool #2
                lastImageAnalysisReport: null, // NEW: Store the raw text output from Tool #3
            };

            // === Elements (PREFIIXED) ===
            const el = (id) => document.getElementById(id);
            const apiKeyEl = el('socio-apiKey');
            const modelEl = el('socio-model');
            const locationEl = el('socio-location');
            const projectNameEl = el('socio-projectName');
            const perspectiveEl = el('socio-perspective');
            const analyzeBtn = el('socio-analyzeBtn');
            const reanalyzeBtn = el('socio-reanalyzeBtn');
            const downloadBtn = el('socio-downloadBtn');
            const clearBtn = el('socio-clearBtn');
            const resultsEl = el('socio-results');
            const logEl = el('socio-log');
            const dotEl = el('socio-dot');
            const statusTextEl = el('socio-statusText');

            // Personas
            const personaControlsEl = el('socio-personaControls');
            const personaSliderEl = el('socio-personaSlider');
            const personaCountLabelEl = el('socio-personaCountLabel');
            const personaTypeEl = el('socio-personaType');
            const personasBtn = el('socio-personasBtn');
            const personasRegenBtn = el('socio-personasRegenBtn');
            const personaMountEl = el('socio-personaMount');
            const personasJsonLabelEl = el('socio-personasJsonLabel');
            const personasJsonBoxEl = el('socio-personasJsonBox');

            // PDF Upload Element (Existing)
            const pdfFileNameDisplayEl = el('socio-pdfFileNameDisplay');
            // NEW PDF Output Elements
            const jsonOutputDisplayEl = el('socio-jsonOutputDisplay');
            const jsonOutputPreEl = el('socio-jsonOutputPre');

            // AIPRAA / Render Analysis Elements
            const aipraaEls = {
                imageUpload: el('socio-imageUpload'),
                analyzeButton: el('socio-analyzeButton'),
                statusMessage: el('socio-statusMessage'),
                spinner: el('socio-spinner'),
                imagePreview: el('socio-imagePreview'),
                imagePreviewContainer: el('socio-imagePreviewContainer'),
                initialReportPrompt: el('socio-initialReportPrompt'),
                analysisReport: el('socio-analysisReport'),
                rawAiOutput: el('socio-rawAiOutput'),
                reportFields: {
                    'Focal Point & Massing': 'socio-comp-focal',
                    'Scale Indicators': 'socio-comp-scale',
                    'Relationship to Ground': 'socio-comp-ground',
                    'Dominant Materials': 'socio-mat-materials',
                    'Window/FaÃ§ade System': 'socio-mat-facade',
                    'Key Features & Detailing': 'socio-mat-detailing',
                    'Contextual Integration': 'socio-context-integration',
                    'Lighting & Shadow Play': 'socio-context-lighting',
                    'Atmospheric Elements': 'socio-context-elements',
                    'Implied Function & Use': 'socio-narrative-function',
                    '"Staging" Elements': 'socio-narrative-staging',
                    'Intended Read': 'socio-narrative-read',
                    'Feature 1': 'socio-striking-1',
                    'Feature 2': 'socio-striking-2',
                    'Feature 3': 'socio-striking-3',
                }
            };

            // NEW Opinion Generator Elements
            const personaSelectorEl = el('socio-personaSelector');
            const generateOpinionBtn = el('socio-generateOpinionBtn');
            const opinionSpinnerEl = el('socio-opinionSpinner');
            const opinionOutputDisplayEl = el('socio-opinionOutputDisplay');
            const opinionPersonaNameEl = el('socio-opinionPersonaName');
            const opinionProsListEl = el('socio-opinionProsList');
            const opinionConsListEl = el('socio-opinionConsList');
            const initialOpinionPromptEl = el('socio-initialOpinionPrompt');


            // === GeminiD2 Perspective prompt map (Existing Feature) ===
            const PERSPECTIVES = {
                general: {
                    label: 'General Overview',
                    prompt: (loc) => `Provide a general socio-cultural summary of ${loc}. Cover key demographics, main functions (e.g., residential, commercial, industrial), and prominent cultural markers.`,
                },
                residents: {
                    label: 'Resident/User Dynamics',
                    prompt: (loc) => `Analyze the type of users or residents typically found in ${loc}. Detail their likely income levels, common activities, travel patterns, and general community engagement.`,
                },
                business: {
                    label: 'Local Business Opportunity',
                    prompt: (loc) => `Analyze ${loc} for local business viability. Identify underserved markets, key economic drivers, typical commercial property costs, and competition levels.`,
                },
                culture: {
                    label: 'Cultural & Demographic Deep Dive',
                    prompt: (loc) => `Provide a deep dive into the demographics, heritage, and culture of ${loc}. Detail ethnic composition, common languages, major cultural events, and defining local customs.`,
                },
                scenario: {
                    label: 'Creative Scenario Planning',
                    prompt: (loc) => `Based on the character of ${loc}, create a brief, respectful, and imaginative future scenario (5 years from now) focusing on a challenge or opportunity for the local community. Clearly label the response as 'CREATIVE SCENARIO: [Your Title]'.`,
                },
            };
const PERSPECTIVE_ROLES = {
  general: `You are an **Urban Sociologist & Planning Analyst**. Be evidence-led, neutral, and specific.
Avoid boosterism and clichÃ©s. Quantify when plausible, flag uncertainty, and avoid making up data.
Prefer short, information-dense paragraphs with clear headings.`,

  residents: `You are an **Ethnographer of Resident Behaviour**.
Describe lived experiences, mobility patterns, time-use, and access to services.
Use careful, non-stereotyped language; ground claims in observable indicators.`,

  business: `You are a **Local Economic Development Analyst**.
Identify demand/supply gaps, anchors, agglomeration effects, and plausible unit economics.
State assumptions explicitly; separate facts, estimates, and risks.`,

  culture: `You are a **Cultural Historian & Demographer**.
Trace heritage, language, events, and institutions shaping identity.
Note demographic trends and their implications for place-making.`,

  scenario: `You are a **Foresight Facilitator (Scenario Planner)**.
Craft one plausible 5-year micro-scenario grounded in todayâ€™s constraints.
Make uncertainties explicit; label signals, drivers, and consequences clearly.`
};
            // === UPDATED: Persona prompt map and Schema ===
            const PERSONA_PROMPTS = {
                direct: {
                    label: 'Direct Stakeholders',
                    context: (loc) => `Based on the latest analysis of the project location: ${loc}. Generate a set of detailed personas that represent **Direct Stakeholders** (the primary users, occupants, and operational staff who will ultimately use the end product). The description for each persona must **clearly articulate how they use the building and the site.** This usage pattern should be the central focus of their description.`,
                },
                indirect: {
                    label: 'Indirect Stakeholders',
                    context: (loc) => `Based on the latest analysis of the project location: ${loc}. Generate a set of detailed personas that represent **Indirect Stakeholders** (individuals in the surrounding area who are affected by the project or building, such as current residents or local business owners). The description for each persona must **focus on their relationship to the project's impact**, acknowledging that they may become users in the future or may simply be impacted by its presence in the area.`,
                },
            };
const PERSONA_CREATOR_ROLE = `You are a **Senior UX Researcher for the Built Environment**.
Produce realistic, non-stereotyped personas grounded in the provided location analysis.
Each persona must be decision-useful: explicit usage of building/site, concrete needs, and testable goals.
Prefer concise bullets over prose. No placeholders or invented statistics.`;


            const PERSONA_SCHEMA = {
                type: "ARRAY",
                items: {
                    type: "OBJECT",
                    properties: {
                        id: { type: "NUMBER" },
                        name: { type: "STRING", description: "First and last name." },
                        archetype: { type: "STRING", description: "A brief, descriptive title (e.g., 'Young Professional', 'Neighborhood Elder')." },
                        age: { type: "NUMBER", description: "Age of the persona." },
                        needs: { type: "ARRAY", items: { type: "STRING" }, description: "3 key needs related to the location." },
                        goals: { type: "ARRAY", items: { type: "STRING" }, description: "3 personal/professional goals." },
                        quote: { type: "STRING", description: "A representative quote about the area or project." },
                        painPoints: { type: "ARRAY", items: { type: "STRING" }, description: "2-3 frustrations with the current environment." },
                    },
                    required: ["id", "name", "archetype", "age", "needs", "goals", "quote"],
                }
            };

            // NEW: Schema for PDF Transcription
            const TRANSCRIPTION_SCHEMA = {
                type: "OBJECT",
                properties: {
                    transcribed_text: {
                        type: "STRING",
                        description: "The full, unedited, raw text content of the PDF."
                    }
                },
                required: ["transcribed_text"]
            };

            // NEW: Schema for Opinion Generator
            const OPINION_SCHEMA = {
                type: "OBJECT",
                properties: {
                    opinions: {
                        type: "OBJECT",
                        properties: {
                            persona_name: { type: "STRING", description: "Name of Persona used as input." },
                            pros: {
                                type: "ARRAY",
                                items: { type: "STRING", description: "Short pro statement based on persona's character (max 15 words)." },
                                description: "List of pros."
                            },
                            cons: {
                                type: "ARRAY",
                                items: { type: "STRING", description: "Short con statement based on persona's character (max 15 words)." },
                                description: "List of cons."
                            }
                        },
                        required: ["persona_name", "pros", "cons"]
                    }
                },
                required: ["opinions"]
            };

            // === Utilities (Encapsulated) ===
            function socio_ts() {
                return new Date().toISOString();
            }

            // NEW: Delay utility for backoff
            const socio_delay = ms => new Promise(res => setTimeout(res, ms));


            /**
             * Replaces the original setStatus.
             */
            function socio_setStatus(kind, msg) {
                statusTextEl.textContent = msg;
                dotEl.classList.remove('ok','err','warn');
                // Update main status indicator
                if (kind === 'ok') dotEl.classList.add('ok');
                else if (kind === 'err') dotEl.classList.add('err');
                else if (kind === 'warn') dotEl.classList.add('warn');
                else if (kind === 'working') dotEl.classList.add('warn'); // Use warn for working state

                // AIPRAA Status Management (using its own element and styling)
                const smEl = aipraaEls.statusMessage;
                if (!smEl) return;

                smEl.textContent = msg;
                smEl.className = 'status-message py-2 px-4 rounded-lg text-sm font-medium transition-all duration-300 mb-4';

                // Clear spinner and update button state
                if(aipraaEls.spinner) aipraaEls.spinner.classList.add('hidden');
                if(opinionSpinnerEl) opinionSpinnerEl.classList.add('hidden'); // NEW: Opinion spinner
                aipraaEls.analyzeButton.disabled = true; // Default to disabled
                generateOpinionBtn.disabled = true; // Default to disabled


                switch (kind) {
                    case 'ready':
                        smEl.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-300');
                        // Enable if image and key are present
                        if (state.imagePart && apiKeyEl.value) aipraaEls.analyzeButton.disabled = false;
                        // Opinion generator button check
                        if (apiKeyEl.value && state.lastRenderedPersonas.length > 0 && state.pdfText && state.lastImageAnalysisReport && personaSelectorEl.value) {
                          generateOpinionBtn.disabled = false;
                        }
                        break;
                    case 'working':
                        smEl.classList.add('bg-indigo-100', 'text-indigo-800', 'border', 'border-indigo-300');
                        if(aipraaEls.spinner) aipraaEls.spinner.classList.remove('hidden');
                        aipraaEls.analyzeButton.disabled = true;
                        generateOpinionBtn.disabled = true;
                        break;
                    case 'working-opinion': // NEW: Specific working state for Opinion Generator
                        smEl.classList.add('bg-indigo-100', 'text-indigo-800', 'border', 'border-indigo-300');
                        if(opinionSpinnerEl) opinionSpinnerEl.classList.remove('hidden');
                        aipraaEls.analyzeButton.disabled = true;
                        generateOpinionBtn.disabled = true;
                        break;
                    case 'ok':
                        smEl.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-300');
                        // Re-enable button
                        if (state.imagePart && apiKeyEl.value) aipraaEls.analyzeButton.disabled = false;
                        if (apiKeyEl.value && state.lastRenderedPersonas.length > 0 && state.pdfText && state.lastImageAnalysisReport && personaSelectorEl.value) {
                          generateOpinionBtn.disabled = false;
                        }
                        break;
                    case 'err':
                        smEl.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300');
                        // Re-enable button
                        if (state.imagePart && apiKeyEl.value) aipraaEls.analyzeButton.disabled = false;
                        if (apiKeyEl.value && state.lastRenderedPersonas.length > 0 && state.pdfText && state.lastImageAnalysisReport && personaSelectorEl.value) {
                          generateOpinionBtn.disabled = false;
                        }
                        break;
                    case 'warn':
                        smEl.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-300');
                        if (state.imagePart && apiKeyEl.value) aipraaEls.analyzeButton.disabled = false;
                        if (apiKeyEl.value && state.lastRenderedPersonas.length > 0 && state.pdfText && state.lastImageAnalysisReport && personaSelectorEl.value) {
                          generateOpinionBtn.disabled = false;
                        }
                        break;
                }
                socio_log(`Status updated to: ${msg} (${kind})`, 'w'); // Use 'w' for general status updates
            }


            /**
             * Replaces AIPRAA's logDebug.
             */
            function socio_log(line, type='t') {
                const time = new Date().toLocaleTimeString();
                const span = document.createElement('div');
                span.innerHTML = `<span class="${type}">[${time}]</span> ${line}`;
                logEl.appendChild(span);
                logEl.scrollTop = logEl.scrollHeight;
            }

            function socio_enableControls() {
                if (state.processing) {
                    // If any process is running, disable all action buttons
                    analyzeBtn.disabled = true;
                    reanalyzeBtn.disabled = true;
                    personasBtn.disabled = true;
                    personasRegenBtn.disabled = true;
                    aipraaEls.analyzeButton.disabled = true; // AIPRAA button
                    generateOpinionBtn.disabled = true; // NEW: Opinion button
                    return;
                }
                const keyOk = apiKeyEl.value.trim().length > 10;
                const locationOk = locationEl.value.trim().length > 1;

                // Opinion Generator Prerequisites
                const opinionOk = keyOk && state.lastRenderedPersonas.length > 0 && state.pdfText && state.lastImageAnalysisReport && personaSelectorEl.value;


                // Location Analysis Controls
                analyzeBtn.disabled = !(keyOk && locationOk);
                reanalyzeBtn.disabled = !(keyOk && state.lastLocation);
                downloadBtn.disabled = state.history.length === 0;

                // Persona controls: only after at least one location analysis
                if (state.history.length > 0) {
                    personaControlsEl.style.display = 'flex';
                    personasBtn.disabled = !keyOk;
                    personasRegenBtn.disabled = !keyOk;
                } else {
                    personaControlsEl.style.display = 'none';
                    personasBtn.disabled = true;
                    personasRegenBtn.disabled = true;
                }

                // AIPRAA Controls
                aipraaEls.analyzeButton.disabled = !(keyOk && state.imagePart);

                // NEW: Opinion Generator Button
                generateOpinionBtn.disabled = !opinionOk;

                // Default message update
                if (!keyOk || !locationOk) {
                    socio_setStatus('ready', 'Ready: Enter API Key and Location to begin analysis.');
                } else if (keyOk && locationOk && state.history.length === 0) {
                    socio_setStatus('ready', 'Location ready. Click "Analyze Location" or upload a render.');
                } else if (opinionOk) {
                    socio_setStatus('ready', 'All inputs are ready. Click "Create Persona Opinions".');
                } else if (keyOk && state.imagePart && state.pdfText && state.lastRenderedPersonas.length > 0) {
                    socio_setStatus('ready', 'All pre-requisites for Opinion Generator are met. Select a persona.');
                } else if (keyOk && state.imagePart) {
                    socio_setStatus('ready', 'Image uploaded. Ready for Render Analysis.');
                } else if (keyOk && state.pdfText) {
                    socio_setStatus('ready', `PDF "${state.pdfFileName}" transcribed.`);
                }
            }

            // NEW UTILITY: Update the Persona Selector Dropdown
            function socio_updatePersonaSelector() {
                personaSelectorEl.innerHTML = '';
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.disabled = true;
                defaultOption.selected = true;
                defaultOption.textContent = state.lastRenderedPersonas.length > 0 ? "Select a Persona" : "No Personas Available";
                personaSelectorEl.appendChild(defaultOption);

                state.lastRenderedPersonas.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p.name; // Use name as the value
                    option.textContent = `${p.name} (${p.archetype})`;
                    personaSelectorEl.appendChild(option);
                });
                // Try to maintain selection if possible, otherwise trigger enableControls
                socio_enableControls();
            }


            function socio_renderResult(item) {
                const block = document.createElement('div');
                block.className = 'result-block';
                const when = new Date(item.ts).toLocaleString();
                block.innerHTML = `
                    <h3>${item.location}</h3>
                    <div class="meta">${item.perspectiveLabel} Â· ${when} Â· Model: ${MODEL_ID}</div>
                    <div>${socio_escapeHtml(item.text).replace(/\n/g, '<br>')}</div>
                `;
                resultsEl.prepend(block);
                // Ensure the initial prompt is removed if an analysis is run
                const initialLocationPrompt = resultsEl.querySelector('.muted');
                if (initialLocationPrompt && initialLocationPrompt.textContent.includes('Run a location analysis')) {
                    initialLocationPrompt.remove();
                }
            }

            function socio_escapeHtml(str) {
                return str.replace(/[&<>"]+/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[s]));
            }

            // NEW: File to Base64 utility function (handles ArrayBuffer to Base64)
            function socio_fileToBase64(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        // The result is an ArrayBuffer, convert it to a Base64 string manually
                        const buffer = reader.result;
                        let binary = '';
                        const bytes = new Uint8Array(buffer);
                        const len = bytes.byteLength;
                        for (let i = 0; i < len; i++) {
                            binary += String.fromCharCode(bytes[i]);
                        }
                        resolve(btoa(binary));
                    };
                    reader.onerror = error => reject(error);
                    reader.readAsArrayBuffer(file);
                });
            }

            /**
             * NEW: Generic API Caller with Exponential Backoff
             */
            async function socio_callApiWithBackoff(apiKey, model, payload, retries = 3) {
                for (let i = 0; i < retries; i++) {
                    try {
                        const url = ENDPOINT(apiKey, model);
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            return await response.json();
                        }

                        // Handle server errors (e.g., 500s) and rate limits (429) by retrying
                        if (response.status >= 500 || response.status === 429) {
                            socio_log(`Transient error (HTTP ${response.status}) on attempt ${i + 1}. Retrying...`, 'w');
                            const waitTime = Math.pow(2, i) * 1000 + (Math.random() * 1000); // Exponential backoff with jitter
                            await socio_delay(waitTime);
                            continue; // Skip to next iteration/retry
                        }

                        // For other non-retryable errors (400, 401, etc.)
                        let errorBody = 'Unknown API error.';
                        try { errorBody = await response.text(); } catch (e) { /* ignore */ }
                        throw new Error(`API Request Failed: HTTP ${response.status}. Body: ${errorBody}`);

                    } catch (err) {
                        if (i === retries - 1) {
                            // This is the last attempt, re-throw the error
                            throw err;
                        }
                        socio_log(`Fetch error on attempt ${i + 1}: ${err.message}. Retrying...`, 'w');
                        const waitTime = Math.pow(2, i) * 1000 + (Math.random() * 1000);
                        await socio_delay(waitTime);
                    }
                }
            }


            /**
             * NEW: Core logic for PDF upload and transcription.
             */
            window.socio_handlePdfUpload = async function(event) { // Must be exposed globally for the onchange attribute in HTML
                const file = event.target.files[0];
                state.pdfText = null;
                jsonOutputDisplayEl.style.display = 'none';
                jsonOutputPreEl.textContent = '';

                if (!file) {
                    state.pdfFileName = null;
                    pdfFileNameDisplayEl.textContent = "No file selected";
                    socio_log('PDF selection cleared.', 'w');
                    socio_enableControls();
                    return;
                }

                state.processing = true;
                socio_enableControls();
                state.pdfFileName = file.name;
                pdfFileNameDisplayEl.textContent = `${file.name} (Processing...)`;
                socio_setStatus('working', `Transcribing PDF: ${file.name}`);
                socio_log(`PDF selected: ${file.name}. Starting Base64 conversion...`, 't');

                if (!apiKeyEl.value) {
                    socio_setStatus('err', 'Error: API Key is required for transcription.');
                    pdfFileNameDisplayEl.textContent = file.name; // Restore filename display
                    state.processing = false;
                    socio_enableControls();
                    return;
                }

                try {
                    // 1. Read file and convert to Base64
                    const base64Data = await socio_fileToBase64(file);
                    socio_log('Base64 conversion complete.', 's');

                    // 2. Prepare Generative Part
                    const pdfPart = {
                        inlineData: {
                            data: base64Data,
                            mimeType: file.type // Should be 'application/pdf'
                        }
                    };

                    // 3. Define prompt and payload
                    const prompt = `You are a specialized document transcriber. Your sole function is to extract the complete, unedited text from the provided PDF file and wrap it in the specified JSON format. DO NOT summarize, analyze, interpret, edit, or comment on the content. Return ONLY the JSON object.`;

                    const payload = {
                        contents: [{
                            role: 'user',
                            parts: [{ text: prompt }, pdfPart]
                        }],
                        generationConfig: {
                            temperature: 0.1, // Low temp for factual extraction
                            responseMimeType: "application/json",
                            responseSchema: TRANSCRIPTION_SCHEMA,
                        }
                    };

                    // 4. Call API with backoff
                    const result = await socio_callApiWithBackoff(apiKeyEl.value, TRANSCRIPTION_MODEL_ID, payload);

                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonText) {
                        throw new Error("API response was empty or did not contain JSON text.");
                    }

                    // 5. Parse and store result
                    const parsedJson = JSON.parse(jsonText);
                    state.pdfText = parsedJson.transcribed_text; // Store transcribed text

                    // 6. Update UI
                    pdfFileNameDisplayEl.textContent = `${file.name} (Transcription OK)`;
                    jsonOutputPreEl.textContent = jsonText;
                    jsonOutputDisplayEl.style.display = 'block';
                    socio_setStatus('ok', `PDF transcription complete for ${file.name}.`);
                    socio_log('PDF transcription OK.', 's');

                } catch (err) {
                    const displayError = err.message.includes('API_KEY_INVALID') ? 'Invalid API Key' : 'See debug log.';
                    socio_setStatus('err', `PDF transcription failed: ${displayError}`);
                    socio_log(`PDF transcription error: ${socio_escapeHtml(err.message || String(err))}`, 'e');
                    pdfFileNameDisplayEl.textContent = file.name; // Restore filename display
                    state.processing = false;
                    socio_enableControls();
                } finally {
                    state.processing = false;
                    socio_enableControls();
                }
            }

            // === Location Analysis Core (Existing Feature) ===
            async function socio_runLocationAnalysis(apiKey, location, perspectiveKey, prompt) {
                if (!apiKey || !location) return;

                state.processing = true;
                socio_enableControls();
                socio_setStatus('working', 'Analyzing location...');
                socio_log(`Location analysis started for: ${location}`, 't');

                try {
                    // Include PDF text if available in the analysis prompt
                    const systemRole = PERSPECTIVE_ROLES[perspectiveKey] || 'You are a neutral analyst.';
const basePrompt = `SYSTEM INSTRUCTION: ${systemRole}\n\n${prompt}`;
const fullPrompt = state.pdfText
  ? `${basePrompt}\n\nProject Brief (from PDF):\n---\n${state.pdfText}\n---`
  : basePrompt;

                    const body = {
                        contents: [{ role: 'user', parts: [{ text: fullPrompt }] }],
                        generationConfig: { temperature: 0.5 }
                    };

                    // Using the new backoff function for general analysis
                    const json = await socio_callApiWithBackoff(apiKey, MODEL_ID, body);

                    const text = json?.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!text) throw new Error("API response was empty.");

                    const item = {
                        ts: socio_ts(),
                        location: location,
                        perspectiveKey: perspectiveKey,
                        perspectiveLabel: PERSPECTIVES[perspectiveKey].label,
                        prompt: fullPrompt,
                        text: text,
                    };

                    state.history.push(item);
                    state.lastLocation = location;
                    socio_renderResult(item);
                    socio_setStatus('ok', 'Location analysis complete.');
                    socio_log('Location analysis OK', 's');

                } catch (err) {
                    socio_setStatus('err', 'Location analysis failed');
                    socio_log(`Location analysis error: ${socio_escapeHtml(err.message || String(err))}`, 'e');
                    alert('Location analysis failed. See Debug Log for details.');
                } finally {
                    state.processing = false;
                    socio_enableControls();
                }
            }


            // === Persona Creation Logic (Existing Feature) ===
            async function socio_runPersonaCreation(apiKey, location, personaType, count) {
                if (!apiKey || !location) throw new Error("Location context or API key is missing.");

                const type = PERSONA_PROMPTS[personaType];
                const latestAnalysis = state.history[state.history.length - 1];

                if (!latestAnalysis) throw new Error("No location analysis context found. Run a location analysis first.");

               const contextPrompt = type.context(location) +
  `\n\nSYSTEM INSTRUCTION: ${PERSONA_CREATOR_ROLE}\n` +
  `\nLatest Location Analysis Context:\n---\n${latestAnalysis.text}\n---\n` +
  `Generate a pool of 20 detailed personas, then randomly select and return exactly ${count} of them.`;

                state.processing = true;
                socio_enableControls();
                socio_setStatus('working', `Generating ${count} ${type.label} personas...`);
                socio_log(`Persona creation started for ${type.label} (count: ${count})`, 't');

                try {
                    const body = {
                        contents: [{ role: 'user', parts: [{ text: contextPrompt }] }],
                        generationConfig: {
                            temperature: 0.7,
                            responseMimeType: "application/json",
                            responseSchema: PERSONA_SCHEMA,
                        }
                    };

                    // Using the new backoff function for persona creation
                    const json = await socio_callApiWithBackoff(apiKey, MODEL_ID, body);

                    const text = json?.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!text) throw new Error("API response was empty or non-JSON.");

                    const personas = JSON.parse(text);

                    socio_setStatus('ok', `Persona creation complete (${personas.length} personas).`);
                    socio_log('Persona creation OK', 's');

                    // Update the global state with the new personas
                    state.lastRenderedPersonas = personas;
                    socio_updatePersonaSelector(); // NEW: Populate the selector

                    return personas;

                } catch (err) {
                    socio_setStatus('err', 'Persona creation failed');
                    socio_log(`Persona creation error: ${socio_escapeHtml(err.message || String(err))}`, 'e');
                    alert('Persona creation failed. See Debug Log for details.');
                    return [];
                } finally {
                    state.processing = false;
                    socio_enableControls();
                }
            }

            function socio_renderPersonas(personas) {
                personaMountEl.innerHTML = '';
                if (personas.length === 0) {
                    personasJsonLabelEl.style.display = 'none';
                    personasJsonBoxEl.style.display = 'none';
                    state.lastRenderedPersonas = []; // Ensure state is cleared
                    socio_updatePersonaSelector();
                    return;
                }

                personas.forEach((p, index) => {
                    const card = document.createElement('div');
                    card.className = 'persona-card';

                    const needsHtml = p.needs && Array.isArray(p.needs) ? p.needs.map(n => `<li>${n}</li>`).join('') : '<li>N/A</li>';
                    const goalsHtml = p.goals && Array.isArray(p.goals) ? p.goals.map(g => `<li>${g}</li>`).join('') : '<li>N/A</li>';
                    const painHtml = p.painPoints && Array.isArray(p.painPoints) ? p.painPoints.map(pp => `<li style="color:var(--danger)">${pp}</li>`).join('') : '<li>N/A</li>';

                    card.innerHTML = `
                        <h3>${p.name || `Persona ${index + 1}`} <span style="color:var(--muted); font-weight:normal; margin-left:8px;">(Age ${p.age || '?'})</span></h3>
                        <div class="tag">${p.archetype || 'Unspecified Role'}</div>
                        <p style="margin:8px 0; font-style:italic; font-size:14px; color:var(--text)">"${p.quote || 'No quote provided.'}"</p>

                        <p style="margin:0; font-size:13px; font-weight: 500;"><span style="color:var(--ok)">Needs:</span></p>
                        <ul class="reasons" style="list-style-type: disc; padding-left: 20px; font-size: 13px;">${needsHtml}</ul>
                        <p style="margin:8px 0 0; font-size:13px; font-weight: 500;"><span style="color:var(--warn)">Goals:</span></p>
                        <ul class="reasons" style="list-style-type: disc; padding-left: 20px; font-size: 13px;">${goalsHtml}</ul>
                        <p style="margin:8px 0 0; font-size:13px; font-weight: 500;"><span style="color:var(--danger)">Pain Points:</span></p>
                        <ul class="reasons" style="list-style-type: disc; padding-left: 20px; font-size: 13px;">${painHtml}</ul>
                    `;
                    personaMountEl.appendChild(card);
                });

                personasJsonLabelEl.style.display = 'block';
                personasJsonBoxEl.style.display = 'block';
                personasJsonBoxEl.textContent = JSON.stringify(personas, null, 2);
            }


            // === AIPRAA / Render Analysis Core Logic (Encapsulated) ===

            /**
             * Converts a Data URL (base64) into a Google Generative AI Part object.
             */
            function socio_dataURLToGenerativePart(dataUrl) {
                const [metadata, base64Data] = dataUrl.split(',');
                const mimeType = metadata.match(/:(.*?);/)[1];
                return {
                    inlineData: {
                        data: base64Data,
                        mimeType
                    },
                };
            }

            /**
             * Handles image file selection and preview.
             */
            function socio_handleImageUpload() {
                const file = aipraaEls.imageUpload.files[0];
                state.imagePart = null; // Reset global image part
                state.lastImageAnalysisReport = null; // NEW: Reset the analysis report state
                aipraaEls.imagePreviewContainer.style.display = 'none';

                if (!file) {
                    socio_setStatus('ready', 'Ready to begin. Please upload an image.');
                    return;
                }

                if (!file.type.match('image/jpeg') && !file.type.match('image/png')) {
                    socio_log(`Invalid file type uploaded: ${file.type}`, 'e');
                    alert('Please upload a valid JPEG or PNG file.');
                    aipraaEls.imageUpload.value = ''; // Clear file input
                    socio_setStatus('err', 'Error: Invalid file type.');
                    return;
                }

                socio_log(`Image file uploaded: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`, 't');

                const reader = new FileReader();
                reader.onload = async (e) => {
                    const dataUrl = e.target.result;
                    // 1. Set Image Preview
                    aipraaEls.imagePreview.src = dataUrl;
                    aipraaEls.imagePreviewContainer.style.display = 'block';

                    // 2. Prepare Part object for Gemini API
                    state.imagePart = socio_dataURLToGenerativePart(dataUrl);
                    socio_log(`Image successfully read and converted to Gemini Part object. MimeType: ${state.imagePart.inlineData.mimeType}`, 't');
                    socio_setStatus('ready', 'Image uploaded and ready for analysis.');
                };

                reader.onerror = (e) => {
                    socio_log(`File reading error: ${e.target.error.name}`, 'e');
                    socio_setStatus('err', 'Error reading image file.');
                };

                reader.readAsDataURL(file);
            }

            /**
             * Constructs the detailed AI analysis prompt.
             */
            function socio_buildAnalysisPrompt() {
                const template = `
You are a highly objective and factual "Visual & Architectural Analyst". Your task is to perform a detailed analysis of the provided architectural render image.

You must STRICTLY ADHERE to the following structured report template and ONLY output the content that fills the bracketed sections. Do not include any of the section titles, numbers, or bracket markers in your final output. Start your response immediately with the content for the first category.

**The structure to fill is (Note: This is for your guidance, DO NOT include it in your output):**
Focal Point & Massing: [AI-generated description]
Scale Indicators: [AI-generated description]
Relationship to Ground: [AI-generated description]
Dominant Materials: [AI-generated description]
Window/FaÃ§ade System: [AI-generated description]
Key Features & Detailing: [AI-generated description]
Contextual Integration: [AI-generated description]
Lighting & Shadow Play: [AI-generated description]
Atmospheric Elements: [AI-generated description]
Implied Function & Use: [AI-generated description]
"Staging" Elements: [AI-generated description]
Intended Read: [AI-generated description]
Feature 1: [AI-generated feature 1]
Feature 2: [AI-generated feature 2]
Feature 3: [AI-generated feature 3]

Your descriptions must be concise, professional, and directly derived from the visual evidence in the render. Ensure a clear line break between each category's analysis.
`;
                socio_log('AI Analysis Prompt successfully constructed.', 't');
                return template.trim();
            }

            /**
             * Calls the Gemini API for analysis (AIPRAA Core).
             */
            async function socio_callGeminiAPI() {
                if (!apiKeyEl.value) {
                    socio_setStatus('err', 'Error: API Key is required.');
                    alert('Please enter your Gemini API Key.');
                    return;
                }
                if (!state.imagePart) {
                    socio_setStatus('err', 'Error: No image uploaded.');
                    alert('Please upload an architectural render.');
                    return;
                }

                state.processing = true;
                socio_enableControls();
                socio_setStatus('working', 'Analyzing Render...');

                const API_KEY = apiKeyEl.value;
                const prompt = socio_buildAnalysisPrompt();

                const payload = {
                    contents: [
                        {
                            parts: [
                                { text: prompt },
                                state.imagePart
                            ]
                        }
                    ],
                    generationConfig: {
                        temperature: 0.2,
                    }
                };

                socio_log('Starting API call to Gemini-2.5-Flash with corrected payload structure...', 't');
                socio_log(`API Request Payload (excluding image data): ${JSON.stringify(payload.contents[0].parts[0])}`, 'w');

                try {
                    // Using the new backoff function for image analysis
                    const result = await socio_callApiWithBackoff(API_KEY, MODEL_ID, payload);

                    const aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!aiResponseText) {
                        socio_log('API response successful but text content was empty or malformed.', 'e');
                        socio_setStatus('err', 'Error: AI returned an empty response.');
                        throw new Error('AI response was empty or malformed.');
                    }

                    socio_log('API Call Successful. Parsing response...', 's');

                    // NEW: Store the raw analysis text for Tool #4
                    state.lastImageAnalysisReport = aiResponseText;

                    aipraaEls.rawAiOutput.textContent = aiResponseText; // Display raw output

                    socio_parseAndPopulateReport(aiResponseText);

                    aipraaEls.initialReportPrompt.style.display = 'none';
                    aipraaEls.analysisReport.style.display = 'block';
                    socio_setStatus('ok', 'Render Analysis Complete!');

                } catch (error) {
                    console.error("Gemini API Error:", error);
                    socio_log(`Unhandled API/Fetch Error: ${error.message}`, 'e');
                    if (!aipraaEls.statusMessage.textContent.includes('Error:')) {
                        socio_setStatus('err', 'Error: An unexpected error occurred.');
                    }
                } finally {
                    state.processing = false;
                    socio_enableControls();
                }
            }

            /**
             * Parses the AI's response text and populates the HTML template.
             */
            function socio_parseAndPopulateReport(aiText) {
                const lines = aiText.trim().split('\n').filter(line => line.trim() !== '');
                const reportKeys = Object.keys(aipraaEls.reportFields);

                if (lines.length !== reportKeys.length) {
                    socio_log(`WARNING: Expected ${reportKeys.length} report fields, but AI returned ${lines.length} lines. Attempting to populate...`, 'w');
                }

                lines.forEach((line, index) => {
                    const key = reportKeys[index];
                    if (key) {
                        const elementId = aipraaEls.reportFields[key];
                        const element = el(elementId);
                        if (element) {
                            const cleanedLine = line.replace(/(\*\*|__)/g, '').trim();
                            element.textContent = cleanedLine || `[No analysis provided for ${key}]`;
                        } else {
                            socio_log(`ERROR: Could not find HTML element for key: ${key} (ID: ${elementId})`, 'e');
                        }
                    }
                });
            }

            // === NEW: OPINION GENERATOR CORE LOGIC (Tool #4) (Encapsulated) ===

            /**
             * Retrieves the full persona object by name from the last rendered pool.
             */
            function socio_getPersonaData(name) {
                return state.lastRenderedPersonas.find(p => p.name === name) || null;
            }

            /**
             * Generates Pro/Con opinions based on Project Brief, Persona, and Image Analysis.
             */
            async function socio_generateOpinions() {
                const apiKey = apiKeyEl.value.trim();
                const personaName = personaSelectorEl.value;
                const personaData = socio_getPersonaData(personaName);
                const briefText = state.pdfText;
                const imageReport = state.lastImageAnalysisReport;

                // 1. Input Validation
                if (!apiKey || !personaName || !personaData || !briefText || !imageReport) {
                    socio_setStatus('err', 'Opinion Generator is missing required context (Key, Persona, Brief, or Render Analysis).');
                    return;
                }

                state.processing = true;
                socio_enableControls();
                socio_setStatus('working-opinion', `Generating opinions for ${personaName}...`);
                socio_log(`Opinion generation started for: ${personaName}`, 't');

                // 2. Prompt Construction
                const personaJson = JSON.stringify(personaData, null, 2);

                const systemInstruction = `You are a **User Experience & Socio-Spatial Design Critic**.
Your role is to **speak as the provided Persona**, representing their authentic voice,
values, and lived experience within the built environment.

Use the *Project Brief* and *Architectural Render Analysis* as supporting evidenceâ€”
not as constraintsâ€”to evaluate how the design aligns or conflicts with the personaâ€™s
needs, expectations, and broader social context.

Draw on reasonable domain knowledge or societal insight when relevant, but clearly
distinguish assumptions from facts. Each observation must be:
- Grounded in the personaâ€™s goals or context;
- Realistic and specific (avoid buzzwords or speculation);
- Expressed in concise bullets of â‰¤15 words.

Your output is a balanced, credible list of **Pros** and **Cons** that reflect the
personaâ€™s perspective on the proposed project.`;
                const userPrompt = `
SYSTEM INSTRUCTION: ${systemInstruction}

--- CONTEXT INPUTS ---

1. PROJECT BRIEF (PDF Transcription):
${briefText}

2. PERSONA DATA (Your Role):
${personaJson}

3. ARCHITECTURAL RENDER ANALYSIS:
${imageReport}

--- TASK ---

Based *only* on the persona's needs, goals, and pain points, and cross-referencing them against the project brief and architectural analysis, generate between 2 and 5 Pros and between 2 and 5 Cons regarding the proposed project.

EACH STATEMENT MUST BE A MAXIMUM OF 15 WORDS.

Return the result ONLY as a JSON object strictly following the required schema.
`;

                // 3. API Call Payload
                const payload = {
                    contents: [{
                        role: 'user',
                        parts: [{ text: userPrompt }]
                    }],
                    generationConfig: {
                        temperature: 0.7, // Higher temp for creative synthesis
                        responseMimeType: "application/json",
                        responseSchema: OPINION_SCHEMA,
                    }
                };

                try {
                    // 4. Call API with backoff
                    const result = await socio_callApiWithBackoff(apiKey, OPINION_MODEL_ID, payload);

                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonText) {
                        throw new Error("API response was empty or did not contain JSON text.");
                    }

                    const parsedJson = JSON.parse(jsonText);
                    const opinions = parsedJson.opinions;

                    // 5. Update UI
                    socio_renderOpinionOutput(opinions);
                    socio_setStatus('ok', `Opinions generated for ${personaName}.`);
                    socio_log('Opinion generation OK.', 's');

                } catch (err) {
                    const displayError = err.message.includes('API_KEY_INVALID') ? 'Invalid API Key' : 'See debug log.';
                    socio_setStatus('err', `Opinion generation failed: ${displayError}`);
                    socio_log(`Opinion generation error: ${socio_escapeHtml(err.message || String(err))}`, 'e');
                } finally {
                    state.processing = false;
                    socio_enableControls();
                }
            }

            /**
             * Renders the parsed opinion data to the UI.
             */
            function socio_renderOpinionOutput(opinions) {
                opinionPersonaNameEl.textContent = `Opinion for: ${opinions.persona_name}`;
                opinionProsListEl.innerHTML = '';
                opinionConsListEl.innerHTML = '';

                opinions.pros.forEach(pro => {
                    const li = document.createElement('li');
                    li.textContent = pro;
                    opinionProsListEl.appendChild(li);
                });

                opinions.cons.forEach(con => {
                    const li = document.createElement('li');
                    li.textContent = con;
                    opinionConsListEl.appendChild(li);
                });

                opinionOutputDisplayEl.style.display = 'block';
                initialOpinionPromptEl.style.display = 'none';
            }


            // === Setup Event Listeners (All Features) ===
            function socio_setupEventListeners() {

                // --- CORE/LOCATION ANALYSIS LISTENERS ---
                analyzeBtn.addEventListener('click', () => {
                    const apiKey = apiKeyEl.value.trim();
                    const location = locationEl.value.trim();
                    const perspectiveKey = perspectiveEl.value;
                    const prompt = PERSPECTIVES[perspectiveKey].prompt(location);
                    socio_runLocationAnalysis(apiKey, location, perspectiveKey, prompt);
                });

                reanalyzeBtn.addEventListener('click', () => {
                    const apiKey = apiKeyEl.value.trim();
                    const location = state.lastLocation;
                    const perspectiveKey = perspectiveEl.value;
                    const prompt = PERSPECTIVES[perspectiveKey].prompt(location);
                    socio_runLocationAnalysis(apiKey, location, perspectiveKey, prompt);
                });

                apiKeyEl.addEventListener('input', socio_enableControls);
                locationEl.addEventListener('input', socio_enableControls);

                clearBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to clear all data (history, images, key)?')) {
                        // A simple reload is used in the original; we mimic that by resetting the tab state.
                        // For a real app, this would involve a soft reset of all encapsulated variables and UI.
                        // For this strict integration, we'll reset state and UI elements for the tab.
                        window.location.reload();
                    }
                });

                // Hotkey for main analysis
                document.addEventListener('keydown', (e) => {
                    // Only trigger if we are in the active tab and the button is not disabled
                    if (document.getElementById('tab-panel-socio').getAttribute('aria-hidden') === 'false' && (e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                        if (!analyzeBtn.disabled) {
                            e.preventDefault();
                            analyzeBtn.click();
                        }
                    }
                });

                // --- PERSONA CREATION LISTENERS ---
                personasBtn.addEventListener('click', async () => {
                    const apiKey = apiKeyEl.value.trim();
                    const location = state.lastLocation;
                    const count = parseInt(personaSliderEl.value, 10);
                    const personaType = personaTypeEl.value;
                    const personas = await socio_runPersonaCreation(apiKey, location, personaType, count);
                    socio_renderPersonas(personas);
                });

                personasRegenBtn.addEventListener('click', async () => {
                    const apiKey = apiKeyEl.value.trim();
                    const location = state.lastLocation;
                    const count = parseInt(personaSliderEl.value, 10);
                    const personaType = personaTypeEl.value;
                    const personas = await socio_runPersonaCreation(apiKey, location, personaType, count);
                    socio_renderPersonas(personas);
                });

                personaSliderEl.addEventListener('input', () => {
                    personaCountLabelEl.textContent = personaSliderEl.value;
                });

                // --- AIPRAA / RENDER ANALYSIS LISTENERS ---
                aipraaEls.imageUpload.addEventListener('change', socio_handleImageUpload);
                aipraaEls.analyzeButton.addEventListener('click', socio_callGeminiAPI);

                // Re-enable/disable AIPRAA button when key is changed
                apiKeyEl.addEventListener('input', () => {
                    if (aipraaEls.statusMessage.textContent.startsWith('Ready') || !state.imagePart) {
                        socio_setStatus('ready', 'Ready to begin.');
                    } else {
                        socio_enableControls(); // Manages the button state
                    }
                });

                // --- NEW OPINION GENERATOR LISTENERS ---
                generateOpinionBtn.addEventListener('click', socio_generateOpinions);
                personaSelectorEl.addEventListener('change', socio_enableControls); // Re-check state when persona is selected

                // --- DOWNLOAD BUTTON (ORIGINAL LOGIC) ---
                downloadBtn.addEventListener('click', () => {
                    // Simple download feature: join history items into a text file
                    const downloadText = state.history.map(item =>
                        `--- ${item.perspectiveLabel} Analysis for ${item.location} (${new Date(item.ts).toLocaleString()}) ---\n\n${item.text}\n\n`
                    ).join('');

                    const blob = new Blob([downloadText], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `SocioCultural_Analysis_${Date.now()}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    socio_log('Analysis downloaded.', 's');
                });
            }

            // Final initialization calls
            socio_setupEventListeners();
            socio_enableControls();
            socio_log('Socio-Cultural Application initialized.', 's');
            window.__initial_auth_token = "placeholder_token_for_env_initialization";
            socio_updatePersonaSelector();
            socio_setStatus('ready', 'Ready to begin.');
        }

        // --- 4. GLOBAL BOOTSTRAP ---

        /**
         * Global initialization function for the entire application.
         */
        function initApp() {
            setupTabListeners();
            // Initialize the first tab (Sketch Enhancer) on load
            switchTab('tab-btn-sketch');
        }

        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
